<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Auth Debug</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
    pre { background: #f4f4f4; padding: 12px; border-radius: 8px; white-space: pre-wrap; word-break: break-all; font-size: 13px; }
    .section { margin: 16px 0; padding: 12px; border: 1px solid #ddd; border-radius: 8px; }
    .label { font-weight: bold; color: #333; }
    .ok { color: green; }
    .bad { color: red; }
    button { padding: 8px 16px; margin: 4px; cursor: pointer; }
  </style>
</head>
<body>
<h2>Auth Debug — dashboard.msfgco.com</h2>
<p>This page does NOT load auth-gate.js, so it won't loop.</p>

<div class="section">
  <div class="label">localStorage</div>
  <pre id="ls"></pre>
</div>

<div class="section">
  <div class="label">Cookies</div>
  <pre id="cookies"></pre>
</div>

<div class="section">
  <div class="label">Token Decode</div>
  <pre id="token-decode"></pre>
</div>

<div class="section">
  <div class="label">Diagnosis</div>
  <pre id="diagnosis"></pre>
</div>

<div class="section">
  <button onclick="clearAll()">Clear All Auth State</button>
  <button onclick="testCognitoRefresh()">Test Cognito Refresh</button>
  <button onclick="window.location.href='/login.html'">Go to Login</button>
  <button onclick="window.location.href='/'">Go to Dashboard</button>
</div>

<div class="section">
  <div class="label">Refresh Test Result</div>
  <pre id="refresh-result">—</pre>
</div>

<script>
  function decodeJwt(token) {
    try {
      var parts = token.split(".");
      if (parts.length !== 3) return { error: "Not a JWT (expected 3 parts, got " + parts.length + ")" };
      var header = JSON.parse(atob(parts[0].replace(/-/g, "+").replace(/_/g, "/")));
      var payload = JSON.parse(atob(parts[1].replace(/-/g, "+").replace(/_/g, "/")));
      return { header: header, payload: payload };
    } catch (e) {
      return { error: "JWT decode error: " + e.message };
    }
  }

  function refresh() {
    // localStorage
    var lsOut = "";
    lsOut += "auth_token: " + (localStorage.getItem("auth_token") ? localStorage.getItem("auth_token").substring(0, 50) + "..." : "(null)") + "\n";
    lsOut += "refresh_token: " + (localStorage.getItem("refresh_token") ? localStorage.getItem("refresh_token").substring(0, 30) + "..." : "(null)") + "\n";
    lsOut += "pkce_verifier: " + (localStorage.getItem("pkce_verifier") || "(null)") + "\n";
    document.getElementById("ls").textContent = lsOut;

    // Cookies
    document.getElementById("cookies").textContent = document.cookie || "(no cookies)";

    // Token decode
    var token = localStorage.getItem("auth_token");
    var cookieMatch = document.cookie.match(/(?:^|;\s*)auth_token=([^;]*)/);
    var cookieToken = cookieMatch ? decodeURIComponent(cookieMatch[1]) : null;

    var out = "";
    if (!token && !cookieToken) {
      out = "No token found anywhere.\n";
    } else {
      if (token) {
        out += "=== localStorage token ===\n";
        var decoded = decodeJwt(token);
        if (decoded.error) {
          out += "ERROR: " + decoded.error + "\n";
          out += "Raw value (first 100 chars): " + token.substring(0, 100) + "\n";
        } else {
          out += JSON.stringify(decoded.header, null, 2) + "\n\n";
          out += JSON.stringify(decoded.payload, null, 2) + "\n";
        }
      }
      if (cookieToken && cookieToken !== token) {
        out += "\n=== cookie token (DIFFERENT from localStorage) ===\n";
        var decoded2 = decodeJwt(cookieToken);
        if (decoded2.error) {
          out += "ERROR: " + decoded2.error + "\n";
        } else {
          out += JSON.stringify(decoded2.payload, null, 2) + "\n";
        }
      }
    }
    document.getElementById("token-decode").textContent = out;

    // Diagnosis
    var diag = "";
    var nowSec = Math.floor(Date.now() / 1000);
    diag += "Browser time (epoch): " + nowSec + "\n";
    diag += "Browser time (human): " + new Date().toISOString() + "\n\n";

    if (token) {
      var d = decodeJwt(token);
      if (d.payload) {
        var exp = d.payload.exp;
        var iat = d.payload.iat;
        diag += "token_use: " + (d.payload.token_use || "NOT SET") + "\n";
        diag += "iat: " + iat + " (" + new Date(iat * 1000).toISOString() + ")\n";
        diag += "exp: " + exp + " (" + new Date(exp * 1000).toISOString() + ")\n";
        diag += "now: " + nowSec + " (" + new Date().toISOString() + ")\n";
        diag += "token age: " + (nowSec - iat) + " seconds\n";
        diag += "expires in: " + (exp - nowSec) + " seconds\n\n";

        if (exp < nowSec) {
          diag += "⛔ TOKEN IS EXPIRED (by " + (nowSec - exp) + " seconds)\n";
          diag += "This is why auth-gate redirects to login.\n";
        } else {
          diag += "✅ TOKEN IS VALID (expires in " + (exp - nowSec) + " seconds)\n";
          diag += "Auth-gate should let the page load.\n";
        }

        diag += "\nclient_id: " + (d.payload.client_id || d.payload.aud || "NOT SET") + "\n";
        diag += "iss: " + (d.payload.iss || "NOT SET") + "\n";
        diag += "sub: " + (d.payload.sub || "NOT SET") + "\n";
      }
    } else {
      diag += "⛔ NO TOKEN — auth-gate will redirect to login.\n";
    }

    document.getElementById("diagnosis").textContent = diag;
  }

  function clearAll() {
    localStorage.removeItem("auth_token");
    localStorage.removeItem("refresh_token");
    localStorage.removeItem("pkce_verifier");
    document.cookie = "auth_token=; path=/; domain=.msfgco.com; expires=Thu, 01 Jan 1970 00:00:00 GMT; Secure";
    document.cookie = "auth_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT";
    refresh();
    alert("Cleared all auth state.");
  }

  function testCognitoRefresh() {
    var rt = localStorage.getItem("refresh_token");
    if (!rt) {
      document.getElementById("refresh-result").textContent = "No refresh_token in localStorage.";
      return;
    }
    document.getElementById("refresh-result").textContent = "Sending refresh request to Cognito...";
    fetch("https://us-west-1s6ie2uego.auth.us-west-1.amazoncognito.com/oauth2/token", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({
        grant_type: "refresh_token",
        client_id: "2t9edrhu5crf8vq3ivigv6jopf",
        refresh_token: rt,
      }),
    }).then(function(r) {
      return r.text().then(function(t) {
        if (!r.ok) {
          document.getElementById("refresh-result").textContent = "FAILED: HTTP " + r.status + "\n" + t;
        } else {
          var tokens = JSON.parse(t);
          var out = "SUCCESS!\n";
          out += "Has access_token: " + !!tokens.access_token + "\n";
          out += "Has refresh_token: " + !!tokens.refresh_token + "\n";
          out += "expires_in: " + tokens.expires_in + "\n\n";
          if (tokens.access_token) {
            var d = decodeJwt(tokens.access_token);
            if (d.payload) {
              out += "New token exp: " + d.payload.exp + " (" + new Date(d.payload.exp * 1000).toISOString() + ")\n";
              out += "New token iat: " + d.payload.iat + " (" + new Date(d.payload.iat * 1000).toISOString() + ")\n";
              out += "Token valid for: " + (d.payload.exp - Math.floor(Date.now()/1000)) + " seconds from now\n";
            }
          }
          document.getElementById("refresh-result").textContent = out;
        }
      });
    }).catch(function(e) {
      document.getElementById("refresh-result").textContent = "ERROR: " + e.message;
    });
  }

  refresh();
</script>
</body>
</html>
