<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Signing in…</title>
  <style>
    body { font-family: system-ui, Arial; padding: 16px; }
    pre { white-space: pre-wrap; word-break: break-word; background: #f4f4f4; padding: 12px; border-radius: 8px; }
  </style>
</head>
<body>
<h2>Signing in…</h2>
<div id="status">Starting…</div>
<pre id="details"></pre>

<script>
  const domain = "https://us-west-1s6ie2uego.auth.us-west-1.amazoncognito.com";
  const clientId = "2t9edrhu5crf8vq3ivigv6jopf";
  const redirectUri = "https://dashboard.msfgco.com/login-callback.html";

  const statusEl = document.getElementById("status");
  const detailsEl = document.getElementById("details");

  (async () => {
    try {
      const params = new URLSearchParams(window.location.search);
      const code = params.get("code");
      statusEl.textContent = "Got redirect. Checking code + verifier…";

      if (!code) {
        statusEl.textContent = "Missing authorization code.";
        detailsEl.textContent = "Full URL: " + window.location.href;
        return;
      }

      const verifier = localStorage.getItem("pkce_verifier");
      if (!verifier) {
        statusEl.textContent = "Missing PKCE verifier (localStorage).";
        detailsEl.textContent = "This usually means you didn’t arrive here from /login.html on the same domain.";
        return;
      }

      statusEl.textContent = "Exchanging code for tokens…";

      const body = new URLSearchParams();
      body.set("grant_type", "authorization_code");
      body.set("client_id", clientId);
      body.set("code", code);
      body.set("redirect_uri", redirectUri);
      body.set("code_verifier", verifier);

      const response = await fetch(domain + "/oauth2/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
      });

      const text = await response.text();

      if (!response.ok) {
        statusEl.textContent = "Token exchange failed (see details).";
        detailsEl.textContent =
          "HTTP " + response.status + "\n\n" +
          text + "\n\n" +
          "redirect_uri used:\n" + redirectUri;
        return;
      }

      const tokens = JSON.parse(text);

      localStorage.setItem("auth_token", tokens.access_token);
      localStorage.removeItem("pkce_verifier");

      // Store refresh token for silent renewal (access tokens expire after ~1 hour)
      if (tokens.refresh_token) {
        localStorage.setItem("refresh_token", tokens.refresh_token);
      }

      // Cookie max-age matches the actual token TTL (defaults to 1 hour)
      var maxAge = tokens.expires_in || 3600;

      // Set cookie on .msfgco.com so all subdomains share the session
      document.cookie = "auth_token=" + encodeURIComponent(tokens.access_token) + "; path=/; domain=.msfgco.com; max-age=" + maxAge + "; SameSite=Lax; Secure";

      // Clear any loop-detection state from auth-gate
      sessionStorage.removeItem("last_auth_redirect");

      statusEl.textContent = "Success. Redirecting to dashboard…";
      detailsEl.textContent = "Token stored. Refresh token: " + (tokens.refresh_token ? "yes" : "no");

      var returnTo = sessionStorage.getItem("return_to");
      sessionStorage.removeItem("return_to");
      window.location.href = returnTo || "/";
    } catch (e) {
      statusEl.textContent = "Unexpected error.";
      detailsEl.textContent = String(e);
    }
  })();
</script>
</body>
</html>