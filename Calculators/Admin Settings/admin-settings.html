<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Settings - MSFG</title>

  <link rel="stylesheet" href="admin-styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/vendor/fontawesome/css/all.min.css" />
</head>

<body>
  <div class="pageHeader">
    <h2 id="pageTitle"><i class="fas fa-cog"></i> Admin Settings</h2>
  </div>

  <!-- Tab Navigation -->
  <div class="admin-tabs">
    <button class="admin-tab active" data-tab="employees">
      <i class="fas fa-users"></i> Employees
    </button>
    <button class="admin-tab" data-tab="investors">
      <i class="fas fa-landmark"></i> Investors
    </button>
    <button class="admin-tab" data-tab="forms">
      <i class="fas fa-file-upload"></i> Forms Library
    </button>
    <button class="admin-tab" data-tab="system">
      <i class="fas fa-server"></i> System
    </button>
    <button class="admin-tab" data-tab="monday">
      <i class="fas fa-sync-alt"></i> Monday.com
    </button>
  </div>

  <!-- ================================================
       TAB: Employees
  ================================================ -->
  <div class="admin-panel active" id="panel-employees">
    <div class="toolbar">
      <h3 style="margin:0; font-size:16px; color:#104547;">
        <i class="fas fa-users"></i> Employee Management
      </h3>
      <div class="toolbar-right">
        <button class="btn btn-primary" id="addUserBtn">
          <i class="fas fa-plus"></i> Add Employee
        </button>
      </div>
    </div>

    <!-- Add/Edit Form -->
    <div class="admin-form" id="userForm">
      <h4 style="margin:0 0 14px; font-size:14px;" id="userFormTitle">Add Employee</h4>
      <div class="form-grid">
        <div class="form-group">
          <label for="userNameInput">Full Name</label>
          <input type="text" id="userNameInput" placeholder="John Doe" required />
        </div>
        <div class="form-group">
          <label for="userEmailInput">Email</label>
          <input type="email" id="userEmailInput" placeholder="john@msfgco.com" required />
        </div>
        <div class="form-group">
          <label for="userInitialsInput">Initials</label>
          <input type="text" id="userInitialsInput" placeholder="JD" maxlength="3" />
        </div>
        <div class="form-group">
          <label for="userRoleSelect">Role</label>
          <select id="userRoleSelect">
            <option value="user">User</option>
            <option value="lo">Loan Officer</option>
            <option value="processor">Processor</option>
            <option value="manager">Manager</option>
            <option value="admin">Admin</option>
          </select>
        </div>
      </div>
      <div class="form-actions">
        <button class="btn btn-secondary" id="userFormCancelBtn">Cancel</button>
        <button class="btn btn-primary" id="userFormSaveBtn">
          <i class="fas fa-save"></i> Save
        </button>
      </div>
    </div>

    <table class="admin-table" id="usersTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Status</th>
          <th style="width:120px;">Actions</th>
        </tr>
      </thead>
      <tbody id="usersBody">
        <tr><td colspan="5" class="state-msg"><i class="fas fa-spinner fa-spin"></i><p>Loading...</p></td></tr>
      </tbody>
    </table>
  </div>

  <!-- ================================================
       TAB: Investors
  ================================================ -->
  <div class="admin-panel" id="panel-investors">
    <div class="toolbar">
      <h3 style="margin:0; font-size:16px; color:#104547;">
        <i class="fas fa-landmark"></i> Investor Database
      </h3>
      <div class="toolbar-right">
        <a href="/index.html" class="btn btn-secondary" target="_opener" onclick="window.opener && window.opener.Investors && window.opener.Investors.showManageModal(); return false;">
          <i class="fas fa-external-link-alt"></i> Open Manage Investors
        </a>
      </div>
    </div>
    <p style="color:#888; font-size:14px;">
      Investors are managed from the main dashboard's Investor Database panel.
      Click the button above to open the Manage Investors modal on the dashboard.
    </p>
    <table class="admin-table" id="investorsTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Account Executive</th>
          <th>States</th>
          <th>Best Programs</th>
        </tr>
      </thead>
      <tbody id="investorsBody">
        <tr><td colspan="4" class="state-msg"><i class="fas fa-spinner fa-spin"></i><p>Loading...</p></td></tr>
      </tbody>
    </table>
  </div>

  <!-- ================================================
       TAB: Forms Library Upload
  ================================================ -->
  <div class="admin-panel" id="panel-forms">
    <div class="toolbar">
      <h3 style="margin:0; font-size:16px; color:#104547;">
        <i class="fas fa-file-upload"></i> Upload to Forms Library
      </h3>
      <div class="toolbar-right">
        <div class="form-group" style="flex-direction:row; align-items:center; gap:8px;">
          <label style="white-space:nowrap; margin:0;">Folder:</label>
          <input type="text" id="uploadFolder" placeholder="e.g. Compliance/2025" style="width:200px;" />
        </div>
      </div>
    </div>

    <div class="upload-zone" id="uploadZone">
      <i class="fas fa-cloud-upload-alt"></i>
      <p>Drop files here or click to browse</p>
      <span class="upload-hint">PDF, DOC, XLSX, images — up to 50 MB</span>
    </div>
    <input type="file" id="fileInput" multiple style="display:none;" />

    <div class="upload-progress" id="uploadProgress">
      <p id="uploadStatusText" style="font-size:13px; margin:0 0 6px;">Uploading...</p>
      <div class="upload-progress-bar">
        <div class="upload-progress-fill" id="uploadProgressFill"></div>
      </div>
    </div>

    <div id="uploadResults"></div>

    <p style="color:#888; font-size:13px; margin-top:16px;">
      <i class="fas fa-info-circle"></i>
      Files are uploaded directly to the <strong>msfg-mortgage-documents-prod</strong> S3 bucket.
      They will appear in the Forms Library file browser immediately.
    </p>
  </div>

  <!-- ================================================
       TAB: System
  ================================================ -->
  <div class="admin-panel" id="panel-system">
    <div class="toolbar">
      <h3 style="margin:0; font-size:16px; color:#104547;">
        <i class="fas fa-server"></i> System Information
      </h3>
      <div class="toolbar-right">
        <button class="btn btn-secondary" id="refreshSystemBtn">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
      </div>
    </div>

    <div class="system-grid" id="systemGrid">
      <div class="system-card">
        <div class="system-card-label">Database</div>
        <div class="system-card-value" id="sysDb">--</div>
      </div>
      <div class="system-card">
        <div class="system-card-label">Active Users</div>
        <div class="system-card-value" id="sysUsers">--</div>
      </div>
      <div class="system-card">
        <div class="system-card-label">Investors</div>
        <div class="system-card-value" id="sysInvestors">--</div>
      </div>
      <div class="system-card">
        <div class="system-card-label">Uptime</div>
        <div class="system-card-value" id="sysUptime">--</div>
      </div>
      <div class="system-card">
        <div class="system-card-label">Environment</div>
        <div class="system-card-value" id="sysEnv">--</div>
      </div>
      <div class="system-card">
        <div class="system-card-label">Version</div>
        <div class="system-card-value" id="sysVersion">--</div>
      </div>
    </div>
  </div>

  <!-- ================================================
       TAB: Monday.com Integration
  ================================================ -->
  <div class="admin-panel" id="panel-monday">

    <!-- API Token -->
    <div class="monday-section">
      <div class="toolbar">
        <h3 style="margin:0; font-size:16px; color:#104547;">
          <i class="fas fa-key"></i> API Token
        </h3>
      </div>
      <p id="mondayTokenStatus" style="font-size:13px; color:#888; margin:0 0 8px;">Checking...</p>
      <div style="display:flex; gap:8px; align-items:center;">
        <input type="password" id="mondayTokenInput" placeholder="Paste your Monday.com API token" style="flex:1; padding:8px 12px; border:1px solid #ddd; border-radius:8px; font-size:13px;" />
        <button class="btn btn-primary btn-sm" id="mondaySaveTokenBtn"><i class="fas fa-save"></i> Save</button>
        <button class="btn btn-secondary btn-sm" id="mondayTestTokenBtn"><i class="fas fa-plug"></i> Test</button>
      </div>
    </div>

    <!-- Board Management -->
    <div class="monday-section">
      <div class="toolbar">
        <h3 style="margin:0; font-size:16px; color:#104547;">
          <i class="fas fa-th-large"></i> Registered Boards
        </h3>
        <div class="toolbar-right">
          <button class="btn btn-primary btn-sm" id="mondayAddBoardBtn"><i class="fas fa-plus"></i> Add Board</button>
        </div>
      </div>

      <!-- Add Board Form (hidden by default) -->
      <div class="admin-form" id="mondayBoardForm">
        <h4 style="margin:0 0 12px; font-size:14px;" id="mondayBoardFormTitle">Add Board</h4>
        <div class="form-grid">
          <div class="form-group">
            <label for="mondayBoardIdInput">Board ID</label>
            <input type="text" id="mondayBoardIdInput" placeholder="e.g. 3946783498" />
          </div>
          <div class="form-group">
            <label for="mondayBoardNameInput">Board Name</label>
            <input type="text" id="mondayBoardNameInput" placeholder="e.g. Purchase Pipeline" />
          </div>
          <div class="form-group">
            <label for="mondayBoardSectionSelect">Target Section</label>
            <select id="mondayBoardSectionSelect">
              <option value="pipeline">Loan Pipeline</option>
              <option value="pre_approvals">Pre-Approvals</option>
              <option value="funded_loans">Loans Funded</option>
            </select>
          </div>
        </div>
        <div class="form-actions">
          <button class="btn btn-secondary" id="mondayBoardFormCancelBtn">Cancel</button>
          <button class="btn btn-primary" id="mondayBoardFormSaveBtn"><i class="fas fa-save"></i> Save Board</button>
        </div>
      </div>

      <table class="admin-table" id="mondayBoardsTable">
        <thead>
          <tr>
            <th>Board ID</th>
            <th>Name</th>
            <th>Section</th>
            <th>Status</th>
            <th style="width:120px;">Actions</th>
          </tr>
        </thead>
        <tbody id="mondayBoardsBody">
          <tr><td colspan="5" class="state-msg"><i class="fas fa-spinner fa-spin"></i><p>Loading...</p></td></tr>
        </tbody>
      </table>
    </div>

    <!-- Column Mappings -->
    <div class="monday-section">
      <div class="toolbar">
        <h3 style="margin:0; font-size:16px; color:#104547;">
          <i class="fas fa-arrows-alt-h"></i> Column Mappings
        </h3>
      </div>
      <p style="font-size:13px; color:#888; margin:0 0 8px;">
        Select a board, load its columns from Monday.com, and map them to dashboard fields.
      </p>
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
        <select id="mondayMappingBoardSelect" style="padding:8px 12px; border:1px solid #ddd; border-radius:8px; font-size:13px; flex:1;">
          <option value="">Select a board...</option>
        </select>
        <button class="btn btn-secondary btn-sm" id="mondayLoadColumnsBtn"><i class="fas fa-download"></i> Load Columns</button>
      </div>
      <div id="mondayMappingsContainer"></div>
      <button class="btn btn-primary btn-sm" id="mondaySaveMappingsBtn" style="display:none; margin-top:8px;">
        <i class="fas fa-save"></i> Save Mappings
      </button>
    </div>

    <!-- Display Config -->
    <div class="monday-section">
      <div class="toolbar">
        <h3 style="margin:0; font-size:16px; color:#104547;">
          <i class="fas fa-table"></i> Pipeline Table Columns
        </h3>
      </div>
      <p style="font-size:13px; color:#888; margin:0 0 8px;">
        Choose which columns appear in the pipeline table, set custom labels, and reorder them.
      </p>
      <div id="mondayDisplayConfig">
        <p style="font-size:13px; color:#888;">Save column mappings first, then configure display here.</p>
      </div>
      <button class="btn btn-primary btn-sm" id="mondaySaveDisplayBtn" style="display:none; margin-top:8px;">
        <i class="fas fa-save"></i> Save Display Settings
      </button>
    </div>

    <!-- Sync Controls -->
    <div class="monday-section">
      <div class="toolbar">
        <h3 style="margin:0; font-size:16px; color:#104547;">
          <i class="fas fa-sync-alt"></i> Sync Controls
        </h3>
        <div class="toolbar-right">
          <button class="btn btn-primary btn-sm" id="mondayRunSyncBtn"><i class="fas fa-play"></i> Run Sync Now</button>
        </div>
      </div>
      <div id="mondaySyncInfo" style="font-size:13px; color:#888; margin-bottom:8px;">No syncs have been run yet.</div>

      <h4 style="font-size:14px; margin:16px 0 8px; color:#104547;"><i class="fas fa-history"></i> Sync History</h4>
      <div id="mondaySyncHistory" style="font-size:13px; color:#888;">Loading...</div>
    </div>
  </div>

  <script>
  (() => {
    'use strict';

    /* ── API Config ── */
    const API_BASE = window.location.protocol === 'https:'
      ? 'https://api.msfgco.com/api'
      : 'http://54.175.238.145:8080/api';

    function getAuthToken() {
      const cookieMatch = document.cookie.match(/(?:^|;\s*)auth_token=([^;]*)/);
      return (
        localStorage.getItem('auth_token') ||
        (cookieMatch ? decodeURIComponent(cookieMatch[1]) : null) ||
        sessionStorage.getItem('auth_token')
      );
    }

    async function api(path, opts = {}) {
      const token = getAuthToken();
      const headers = { ...(opts.headers || {}) };
      if (token) headers['Authorization'] = 'Bearer ' + token;
      if (!headers['Content-Type'] && opts.body && typeof opts.body === 'string') {
        headers['Content-Type'] = 'application/json';
      }

      const res = await fetch(API_BASE + path, { ...opts, headers });

      if (res.status === 401) {
        alert('Session expired. Please log in again.');
        return null;
      }
      if (res.status === 403) {
        alert('Admin access required.');
        return null;
      }
      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || res.statusText);
      }
      return res.json();
    }

    function escHtml(str) {
      if (!str) return '';
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }

    /* ── Tabs ── */
    document.querySelectorAll('.admin-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('panel-' + tab.dataset.tab).classList.add('active');

        // Load data on tab switch
        const tabName = tab.dataset.tab;
        if (tabName === 'employees') loadUsers();
        if (tabName === 'investors') loadInvestors();
        if (tabName === 'system') loadSystem();
        if (tabName === 'monday') loadMondayTab();
      });
    });

    /* ═══════════════════════════════════════
       EMPLOYEES TAB
    ═══════════════════════════════════════ */
    let editingUserId = null;

    async function loadUsers() {
      const tbody = document.getElementById('usersBody');
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:#999;"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';

      try {
        const users = await api('/admin/users');
        if (!users) return;

        if (users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:#999;">No users found.</td></tr>';
          return;
        }

        tbody.innerHTML = users.map(u => {
          const statusBadge = u.is_active
            ? '<span class="badge badge-active">Active</span>'
            : '<span class="badge badge-inactive">Inactive</span>';
          const roleBadge = u.role === 'admin'
            ? '<span class="badge badge-admin">' + escHtml(u.role) + '</span>'
            : escHtml(u.role || 'user');

          return (
            '<tr data-user-id="' + u.id + '">' +
            '<td><strong>' + escHtml(u.name) + '</strong></td>' +
            '<td>' + escHtml(u.email) + '</td>' +
            '<td>' + roleBadge + '</td>' +
            '<td>' + statusBadge + '</td>' +
            '<td>' +
              '<button class="btn btn-sm btn-secondary edit-user-btn" data-id="' + u.id + '" title="Edit"><i class="fas fa-edit"></i></button> ' +
              (u.is_active
                ? '<button class="btn btn-sm btn-danger deactivate-user-btn" data-id="' + u.id + '" title="Deactivate"><i class="fas fa-user-slash"></i></button>'
                : '<button class="btn btn-sm btn-primary activate-user-btn" data-id="' + u.id + '" title="Activate"><i class="fas fa-user-check"></i></button>'
              ) +
            '</td>' +
            '</tr>'
          );
        }).join('');

        // Bind edit buttons
        tbody.querySelectorAll('.edit-user-btn').forEach(btn => {
          btn.addEventListener('click', () => editUser(users.find(u => String(u.id) === btn.dataset.id)));
        });

        // Bind deactivate buttons
        tbody.querySelectorAll('.deactivate-user-btn').forEach(btn => {
          btn.addEventListener('click', () => toggleUserActive(btn.dataset.id, false));
        });

        // Bind activate buttons
        tbody.querySelectorAll('.activate-user-btn').forEach(btn => {
          btn.addEventListener('click', () => toggleUserActive(btn.dataset.id, true));
        });
      } catch (err) {
        console.error('Load users error:', err);
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:#e74c3c;">Failed to load users.</td></tr>';
      }
    }

    function showUserForm(user) {
      const form = document.getElementById('userForm');
      const title = document.getElementById('userFormTitle');

      if (user) {
        editingUserId = user.id;
        title.textContent = 'Edit Employee';
        document.getElementById('userNameInput').value = user.name || '';
        document.getElementById('userEmailInput').value = user.email || '';
        document.getElementById('userEmailInput').disabled = true;
        document.getElementById('userInitialsInput').value = user.initials || '';
        document.getElementById('userRoleSelect').value = user.role || 'user';
      } else {
        editingUserId = null;
        title.textContent = 'Add Employee';
        document.getElementById('userNameInput').value = '';
        document.getElementById('userEmailInput').value = '';
        document.getElementById('userEmailInput').disabled = false;
        document.getElementById('userInitialsInput').value = '';
        document.getElementById('userRoleSelect').value = 'user';
      }

      form.classList.add('active');
    }

    function hideUserForm() {
      document.getElementById('userForm').classList.remove('active');
      editingUserId = null;
    }

    function editUser(user) {
      if (user) showUserForm(user);
    }

    async function saveUser() {
      const name = document.getElementById('userNameInput').value.trim();
      const email = document.getElementById('userEmailInput').value.trim();
      const initials = document.getElementById('userInitialsInput').value.trim();
      const role = document.getElementById('userRoleSelect').value;

      if (!name) return alert('Name is required');
      if (!editingUserId && !email) return alert('Email is required');

      try {
        if (editingUserId) {
          await api('/admin/users/' + editingUserId, {
            method: 'PUT',
            body: JSON.stringify({ name, initials, role }),
          });
        } else {
          await api('/admin/users', {
            method: 'POST',
            body: JSON.stringify({ email, name, initials, role }),
          });
        }

        hideUserForm();
        loadUsers();
      } catch (err) {
        alert('Error saving user: ' + err.message);
      }
    }

    async function toggleUserActive(userId, activate) {
      const action = activate ? 'activate' : 'deactivate';
      if (!confirm('Are you sure you want to ' + action + ' this user?')) return;

      try {
        if (activate) {
          await api('/admin/users/' + userId, {
            method: 'PUT',
            body: JSON.stringify({ is_active: true }),
          });
        } else {
          await api('/admin/users/' + userId, { method: 'DELETE' });
        }
        loadUsers();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Employee event listeners
    document.getElementById('addUserBtn').addEventListener('click', () => showUserForm(null));
    document.getElementById('userFormCancelBtn').addEventListener('click', hideUserForm);
    document.getElementById('userFormSaveBtn').addEventListener('click', saveUser);

    /* ═══════════════════════════════════════
       INVESTORS TAB
    ═══════════════════════════════════════ */
    async function loadInvestors() {
      const tbody = document.getElementById('investorsBody');
      tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:30px; color:#999;"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';

      try {
        const investors = await api('/investors');
        if (!investors) return;

        if (investors.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:30px; color:#999;">No investors.</td></tr>';
          return;
        }

        tbody.innerHTML = investors.map(inv =>
          '<tr>' +
          '<td><strong>' + escHtml(inv.name) + '</strong></td>' +
          '<td>' + escHtml(inv.account_executive_name || '--') + '</td>' +
          '<td>' + escHtml(inv.states || '--') + '</td>' +
          '<td>' + escHtml(inv.best_programs || '--') + '</td>' +
          '</tr>'
        ).join('');
      } catch (err) {
        console.error('Load investors error:', err);
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:30px; color:#e74c3c;">Failed to load investors.</td></tr>';
      }
    }

    /* ═══════════════════════════════════════
       FORMS LIBRARY UPLOAD TAB
    ═══════════════════════════════════════ */
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');

    uploadZone.addEventListener('click', () => fileInput.click());

    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', () => {
      handleFiles(fileInput.files);
      fileInput.value = '';
    });

    async function handleFiles(files) {
      if (!files || files.length === 0) return;

      const folder = document.getElementById('uploadFolder').value.trim();
      const progressEl = document.getElementById('uploadProgress');
      const statusText = document.getElementById('uploadStatusText');
      const progressFill = document.getElementById('uploadProgressFill');
      const resultsEl = document.getElementById('uploadResults');

      progressEl.style.display = 'block';
      resultsEl.innerHTML = '';

      let completed = 0;
      const total = files.length;

      for (const file of files) {
        statusText.textContent = 'Uploading ' + file.name + ' (' + (completed + 1) + '/' + total + ')...';
        progressFill.style.width = ((completed / total) * 100) + '%';

        try {
          // Get presigned URL
          const urlData = await api('/admin/files/upload-url', {
            method: 'POST',
            body: JSON.stringify({
              fileName: file.name,
              fileType: file.type || 'application/octet-stream',
              folder: folder,
            }),
          });

          if (!urlData) continue;

          // Upload to S3
          const uploadRes = await fetch(urlData.uploadUrl, {
            method: 'PUT',
            headers: { 'Content-Type': file.type || 'application/octet-stream' },
            body: file,
          });

          if (!uploadRes.ok) throw new Error('Upload failed');

          resultsEl.innerHTML += '<p style="color:#2e7d32; font-size:13px;"><i class="fas fa-check-circle"></i> ' + escHtml(file.name) + ' uploaded successfully</p>';
        } catch (err) {
          resultsEl.innerHTML += '<p style="color:#e74c3c; font-size:13px;"><i class="fas fa-times-circle"></i> ' + escHtml(file.name) + ' failed: ' + escHtml(err.message) + '</p>';
        }

        completed++;
      }

      progressFill.style.width = '100%';
      statusText.textContent = 'Upload complete! ' + completed + '/' + total + ' files uploaded.';

      setTimeout(() => { progressEl.style.display = 'none'; }, 3000);
    }

    /* ═══════════════════════════════════════
       SYSTEM TAB
    ═══════════════════════════════════════ */
    async function loadSystem() {
      try {
        const info = await api('/admin/system');
        if (!info) return;

        const dbEl = document.getElementById('sysDb');
        dbEl.textContent = info.database === 'connected' ? 'Connected' : 'Error';
        dbEl.className = 'system-card-value ' + (info.database === 'connected' ? 'ok' : 'error');

        document.getElementById('sysUsers').textContent = info.activeUsers;
        document.getElementById('sysInvestors').textContent = info.totalInvestors;

        // Format uptime
        const hrs = Math.floor(info.uptime / 3600);
        const mins = Math.floor((info.uptime % 3600) / 60);
        document.getElementById('sysUptime').textContent = hrs + 'h ' + mins + 'm';

        document.getElementById('sysEnv').textContent = info.environment;
        document.getElementById('sysVersion').textContent = 'v' + info.version;
      } catch (err) {
        console.error('System info error:', err);
      }
    }

    document.getElementById('refreshSystemBtn').addEventListener('click', loadSystem);

    /* ═══════════════════════════════════════
       MONDAY.COM TAB
    ═══════════════════════════════════════ */
    let mondayBoards = [];
    let mondayBoardColumns = [];
    let mondayCurrentBoardId = null;
    let mondayEditingBoardId = null;

    function loadMondayTab() {
      loadMondayBoards();
      loadMondayTokenStatus();
      loadMondaySyncHistory();
      loadMondayDisplayConfig();
    }

    // ── Token Management ──
    async function loadMondayTokenStatus() {
      try {
        const integrations = await api('/integrations');
        if (!integrations) return;
        const monday = integrations.find(i => i.service === 'monday');
        const status = document.getElementById('mondayTokenStatus');
        if (monday) {
          status.textContent = 'Token configured (' + (monday.maskedValue || '***') + '). Last tested: ' + (monday.last_tested_at ? new Date(monday.last_tested_at).toLocaleString() : 'Never');
          status.style.color = '#2e7d32';
        } else {
          status.textContent = 'No token configured. Paste your Monday.com API token below.';
          status.style.color = '#f39c12';
        }
      } catch (e) { /* non-critical */ }
    }

    async function saveMondayToken() {
      const input = document.getElementById('mondayTokenInput');
      const value = input.value.trim();
      if (!value) return alert('Please enter a token.');
      try {
        await api('/integrations', {
          method: 'POST',
          body: JSON.stringify({ service: 'monday', credential_type: 'api_key', value: value, label: 'Monday.com API Token' }),
        });
        input.value = '';
        loadMondayTokenStatus();
        alert('Token saved!');
      } catch (err) { alert('Failed to save token: ' + err.message); }
    }

    async function testMondayToken() {
      const status = document.getElementById('mondayTokenStatus');
      status.textContent = 'Testing connection...';
      status.style.color = '#888';
      try {
        const result = await api('/integrations/monday/test', { method: 'POST', body: '{}' });
        if (result && result.success) {
          status.textContent = result.message || 'Connection successful!';
          status.style.color = '#2e7d32';
        } else {
          status.textContent = 'Test failed: ' + (result ? result.message : 'Unknown error');
          status.style.color = '#e74c3c';
        }
      } catch (err) {
        status.textContent = 'Test failed: ' + err.message;
        status.style.color = '#e74c3c';
      }
    }

    document.getElementById('mondaySaveTokenBtn').addEventListener('click', saveMondayToken);
    document.getElementById('mondayTestTokenBtn').addEventListener('click', testMondayToken);

    // ── Board Management ──
    async function loadMondayBoards() {
      const tbody = document.getElementById('mondayBoardsBody');
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#999;"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';

      try {
        const data = await api('/monday/boards');
        if (!data) return;
        mondayBoards = data.boards || [];

        if (mondayBoards.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#999;">No boards registered. Click "Add Board" to get started.</td></tr>';
          populateBoardSelect([]);
          return;
        }

        const sectionLabels = { pipeline: 'Loan Pipeline', pre_approvals: 'Pre-Approvals', funded_loans: 'Loans Funded' };
        const sectionClasses = { pipeline: 'section-pipeline', pre_approvals: 'section-preapprovals', funded_loans: 'section-funded' };

        tbody.innerHTML = mondayBoards.map(b =>
          '<tr data-board-id="' + escHtml(b.board_id) + '">' +
          '<td><code style="font-size:12px;">' + escHtml(b.board_id) + '</code></td>' +
          '<td><strong>' + escHtml(b.board_name || 'Unnamed') + '</strong></td>' +
          '<td><span class="badge ' + (sectionClasses[b.target_section] || '') + '">' + escHtml(sectionLabels[b.target_section] || b.target_section) + '</span></td>' +
          '<td>' + (b.is_active ? '<span class="badge badge-active">Active</span>' : '<span class="badge badge-inactive">Inactive</span>') + '</td>' +
          '<td>' +
            '<button class="btn btn-sm btn-secondary monday-edit-board" data-bid="' + escHtml(b.board_id) + '" title="Edit"><i class="fas fa-edit"></i></button> ' +
            '<button class="btn btn-sm btn-danger monday-delete-board" data-bid="' + escHtml(b.board_id) + '" title="Remove"><i class="fas fa-trash"></i></button>' +
          '</td>' +
          '</tr>'
        ).join('');

        // Bind edit buttons
        tbody.querySelectorAll('.monday-edit-board').forEach(btn => {
          btn.addEventListener('click', () => {
            const board = mondayBoards.find(b => b.board_id === btn.dataset.bid);
            if (board) showBoardForm(board);
          });
        });

        // Bind delete buttons
        tbody.querySelectorAll('.monday-delete-board').forEach(btn => {
          btn.addEventListener('click', () => deleteMondayBoard(btn.dataset.bid));
        });

        populateBoardSelect(mondayBoards);
      } catch (err) {
        console.error('Load boards error:', err);
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#e74c3c;">Failed to load boards.</td></tr>';
      }
    }

    function populateBoardSelect(boards) {
      const select = document.getElementById('mondayMappingBoardSelect');
      select.innerHTML = '<option value="">Select a board...</option>' +
        boards.map(b => '<option value="' + escHtml(b.board_id) + '">' + escHtml(b.board_name || b.board_id) + ' (' + escHtml(b.board_id) + ')</option>').join('');
    }

    function showBoardForm(board) {
      const form = document.getElementById('mondayBoardForm');
      const title = document.getElementById('mondayBoardFormTitle');
      if (board) {
        mondayEditingBoardId = board.board_id;
        title.textContent = 'Edit Board';
        document.getElementById('mondayBoardIdInput').value = board.board_id;
        document.getElementById('mondayBoardIdInput').disabled = true;
        document.getElementById('mondayBoardNameInput').value = board.board_name || '';
        document.getElementById('mondayBoardSectionSelect').value = board.target_section || 'pipeline';
      } else {
        mondayEditingBoardId = null;
        title.textContent = 'Add Board';
        document.getElementById('mondayBoardIdInput').value = '';
        document.getElementById('mondayBoardIdInput').disabled = false;
        document.getElementById('mondayBoardNameInput').value = '';
        document.getElementById('mondayBoardSectionSelect').value = 'pipeline';
      }
      form.classList.add('active');
    }

    function hideBoardForm() {
      document.getElementById('mondayBoardForm').classList.remove('active');
      mondayEditingBoardId = null;
    }

    async function saveMondayBoard() {
      const boardId = document.getElementById('mondayBoardIdInput').value.trim();
      const boardName = document.getElementById('mondayBoardNameInput').value.trim();
      const targetSection = document.getElementById('mondayBoardSectionSelect').value;

      if (!boardId) return alert('Board ID is required');

      try {
        if (mondayEditingBoardId) {
          await api('/monday/boards/' + mondayEditingBoardId, {
            method: 'PUT',
            body: JSON.stringify({ boardName, targetSection }),
          });
        } else {
          await api('/monday/boards', {
            method: 'POST',
            body: JSON.stringify({ boardId, boardName, targetSection }),
          });
        }
        hideBoardForm();
        loadMondayBoards();
      } catch (err) { alert('Error saving board: ' + err.message); }
    }

    async function deleteMondayBoard(boardId) {
      if (!confirm('Remove board ' + boardId + '? This will also delete its column mappings and sync history.')) return;
      try {
        await api('/monday/boards/' + boardId, { method: 'DELETE' });
        loadMondayBoards();
      } catch (err) { alert('Error removing board: ' + err.message); }
    }

    document.getElementById('mondayAddBoardBtn').addEventListener('click', () => showBoardForm(null));
    document.getElementById('mondayBoardFormCancelBtn').addEventListener('click', hideBoardForm);
    document.getElementById('mondayBoardFormSaveBtn').addEventListener('click', saveMondayBoard);

    // ── Column Mappings ──
    async function loadMondayColumns() {
      const boardId = document.getElementById('mondayMappingBoardSelect').value;
      if (!boardId) return alert('Please select a board first.');

      mondayCurrentBoardId = boardId;
      const container = document.getElementById('mondayMappingsContainer');
      const saveBtn = document.getElementById('mondaySaveMappingsBtn');
      container.innerHTML = '<p style="color:#888; font-size:13px;"><i class="fas fa-spinner fa-spin"></i> Loading columns from Monday.com...</p>';

      try {
        const data = await api('/monday/columns?board=' + boardId);
        if (!data) return;

        mondayBoardColumns = data.columns || [];
        const validFields = data.validPipelineFields || [];
        const fieldLabels = data.fieldLabels || {};
        const section = data.targetSection || 'pipeline';

        // Load existing mappings
        let existingMappings = {};
        try {
          const saved = await api('/monday/mappings?board=' + boardId);
          if (saved) saved.forEach(m => { existingMappings[m.monday_column_id] = m.pipeline_field; });
        } catch (e) { /* first time */ }

        if (mondayBoardColumns.length === 0) {
          container.innerHTML = '<p style="color:#888; font-size:13px;">No columns found on this board.</p>';
          return;
        }

        const sectionLabels = { pipeline: 'Pipeline', pre_approvals: 'Pre-Approvals', funded_loans: 'Funded Loans' };

        container.innerHTML =
          '<p style="font-size:12px; color:#888; margin:0 0 6px;">Board: <strong>' + escHtml(data.boardName) + '</strong> — ' + mondayBoardColumns.length + ' columns — Section: <span class="badge ' + (section === 'pipeline' ? 'section-pipeline' : section === 'pre_approvals' ? 'section-preapprovals' : 'section-funded') + '">' + escHtml(sectionLabels[section] || section) + '</span></p>' +
          '<div style="max-height:350px; overflow-y:auto; border:1px solid #eee; border-radius:8px;">' +
            '<table class="admin-table" style="margin:0; font-size:12px;">' +
              '<thead><tr><th>Monday.com Column</th><th>Type</th><th>Maps To</th></tr></thead>' +
              '<tbody>' +
                mondayBoardColumns.map(col => {
                  const savedField = existingMappings[col.id] || col.suggestedField || '';
                  return '<tr>' +
                    '<td>' + escHtml(col.title) + '</td>' +
                    '<td><code style="font-size:11px;">' + escHtml(col.type) + '</code></td>' +
                    '<td><select class="monday-mapping-select" data-col-id="' + escHtml(col.id) + '" data-col-title="' + escHtml(col.title) + '" style="padding:4px 8px; font-size:12px; border:1px solid #ddd; border-radius:6px; width:100%;">' +
                      '<option value="">— skip —</option>' +
                      validFields.map(f => '<option value="' + f + '"' + (f === savedField ? ' selected' : '') + '>' + escHtml(fieldLabels[f] || f) + '</option>').join('') +
                    '</select></td>' +
                  '</tr>';
                }).join('') +
              '</tbody>' +
            '</table>' +
          '</div>';

        saveBtn.style.display = '';
      } catch (err) {
        container.innerHTML = '<p style="color:#e74c3c; font-size:13px;">Failed to load columns: ' + escHtml(err.message) + '</p>';
      }
    }

    async function saveMondayMappings() {
      const selects = document.querySelectorAll('.monday-mapping-select');
      const mappings = [];
      selects.forEach(sel => {
        if (sel.value) {
          mappings.push({
            mondayColumnId: sel.dataset.colId,
            mondayColumnTitle: sel.dataset.colTitle,
            pipelineField: sel.value,
          });
        }
      });

      if (mappings.length === 0) return alert('Please map at least one column.');

      // Check for duplicates
      const fields = mappings.map(m => m.pipelineField);
      const dupes = fields.filter((f, i) => fields.indexOf(f) !== i);
      if (dupes.length > 0) return alert('Duplicate mapping: "' + dupes[0] + '" is mapped to multiple columns.');

      try {
        await api('/monday/mappings', {
          method: 'POST',
          body: JSON.stringify({ mappings, boardId: mondayCurrentBoardId }),
        });
        alert('Mappings saved for board ' + mondayCurrentBoardId + '! (' + mappings.length + ' columns mapped)');
        loadMondayDisplayConfig();
      } catch (err) { alert('Failed to save: ' + err.message); }
    }

    document.getElementById('mondayLoadColumnsBtn').addEventListener('click', loadMondayColumns);
    document.getElementById('mondaySaveMappingsBtn').addEventListener('click', saveMondayMappings);

    // ── Display Config ──
    async function loadMondayDisplayConfig() {
      const container = document.getElementById('mondayDisplayConfig');
      const saveBtn = document.getElementById('mondaySaveDisplayBtn');
      if (!container) return;

      try {
        const config = await api('/monday/view-config');
        if (!config) return;
        const columns = config.columns || [];

        if (columns.length <= 1) {
          container.innerHTML = '<p style="font-size:13px; color:#888;">Save column mappings first, then configure display here.</p>';
          saveBtn.style.display = 'none';
          return;
        }

        container.innerHTML =
          '<div style="max-height:350px; overflow-y:auto; border:1px solid #eee; border-radius:8px;">' +
            '<table class="admin-table" style="margin:0; font-size:12px;" id="displayConfigTable">' +
              '<thead><tr><th style="width:40px;">Show</th><th>Field</th><th>Label</th><th style="width:80px;">Order</th></tr></thead>' +
              '<tbody>' +
                columns.map((col, idx) => {
                  const isLocked = col.locked;
                  return '<tr data-field="' + col.field + '">' +
                    '<td style="text-align:center;"><input type="checkbox" class="dc-visible"' + (col.visible !== false ? ' checked' : '') + (isLocked ? ' disabled' : '') + ' /></td>' +
                    '<td><code style="font-size:11px;">' + escHtml(col.field) + '</code></td>' +
                    '<td><input type="text" class="dc-label" value="' + escHtml(col.label || '') + '"' + (isLocked ? ' disabled' : '') + ' style="padding:4px 8px; font-size:12px; border:1px solid #ddd; border-radius:6px; width:100%;" /></td>' +
                    '<td style="text-align:center;">' +
                      '<button type="button" class="btn btn-secondary btn-sm dc-move-up" style="padding:2px 6px; font-size:10px;"' + (idx === 0 ? ' disabled' : '') + '>&#9650;</button> ' +
                      '<button type="button" class="btn btn-secondary btn-sm dc-move-down" style="padding:2px 6px; font-size:10px;"' + (idx === columns.length - 1 ? ' disabled' : '') + '>&#9660;</button>' +
                    '</td>' +
                  '</tr>';
                }).join('') +
              '</tbody>' +
            '</table>' +
          '</div>';

        saveBtn.style.display = '';

        // Wire move buttons
        container.querySelectorAll('.dc-move-up').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const row = e.target.closest('tr');
            const prev = row.previousElementSibling;
            if (prev) row.parentNode.insertBefore(row, prev);
            updateMoveButtons();
          });
        });
        container.querySelectorAll('.dc-move-down').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const row = e.target.closest('tr');
            const next = row.nextElementSibling;
            if (next) row.parentNode.insertBefore(next, row);
            updateMoveButtons();
          });
        });
      } catch (err) {
        container.innerHTML = '<p style="color:#e74c3c; font-size:13px;">Failed to load display config: ' + escHtml(err.message) + '</p>';
      }
    }

    function updateMoveButtons() {
      const rows = document.querySelectorAll('#displayConfigTable tbody tr');
      rows.forEach((row, idx) => {
        const up = row.querySelector('.dc-move-up');
        const down = row.querySelector('.dc-move-down');
        if (up) up.disabled = idx === 0;
        if (down) down.disabled = idx === rows.length - 1;
      });
    }

    async function saveMondayDisplaySettings() {
      const rows = document.querySelectorAll('#displayConfigTable tbody tr');
      const displayConfig = {};
      let order = 0;
      rows.forEach(row => {
        const field = row.dataset.field;
        if (field === 'client_name') return;
        displayConfig[field] = {
          displayLabel: row.querySelector('.dc-label').value.trim() || null,
          displayOrder: order++,
          visible: row.querySelector('.dc-visible').checked,
        };
      });

      try {
        // Get all board IDs
        const data = await api('/monday/boards');
        if (!data) return;
        const boards = (data.boards || []).filter(b => b.is_active);

        for (const board of boards) {
          let boardMappings = [];
          try { boardMappings = await api('/monday/mappings?board=' + board.board_id); } catch (e) { continue; }
          if (!boardMappings || boardMappings.length === 0) continue;

          const updated = boardMappings.map(m => ({
            mondayColumnId: m.monday_column_id,
            mondayColumnTitle: m.monday_column_title,
            pipelineField: m.pipeline_field,
            displayLabel: displayConfig[m.pipeline_field] ? displayConfig[m.pipeline_field].displayLabel : (m.display_label || null),
            displayOrder: displayConfig[m.pipeline_field] ? displayConfig[m.pipeline_field].displayOrder : (m.display_order || 99),
            visible: displayConfig[m.pipeline_field] ? displayConfig[m.pipeline_field].visible : (m.visible !== 0),
          }));

          await api('/monday/mappings', {
            method: 'POST',
            body: JSON.stringify({ mappings: updated, boardId: board.board_id }),
          });
        }

        alert('Display settings saved!');
      } catch (err) { alert('Failed to save display settings: ' + err.message); }
    }

    document.getElementById('mondaySaveDisplayBtn').addEventListener('click', saveMondayDisplaySettings);

    // ── Sync Controls ──
    async function runMondaySync() {
      const btn = document.getElementById('mondayRunSyncBtn');
      const info = document.getElementById('mondaySyncInfo');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
      info.textContent = 'Sync in progress...';

      try {
        const result = await api('/monday/sync', { method: 'POST', body: '{}' });
        if (!result) { info.textContent = 'Sync failed.'; return; }
        const delMsg = result.deleted ? ', ' + result.deleted + ' removed' : '';
        info.innerHTML = '<span style="color:#2e7d32;">Sync complete! ' + result.itemsFetched + ' items (' + result.created + ' new, ' + result.updated + ' updated' + delMsg + ')</span>';
        loadMondaySyncHistory();
      } catch (err) {
        info.innerHTML = '<span style="color:#e74c3c;">Sync failed: ' + escHtml(err.message) + '</span>';
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-play"></i> Run Sync Now';
      }
    }

    async function loadMondaySyncHistory() {
      const container = document.getElementById('mondaySyncHistory');
      if (!container) return;

      try {
        const logs = await api('/monday/sync/log');
        if (!logs || logs.length === 0) {
          container.textContent = 'No syncs have been run yet.';
          return;
        }

        const statusColors = { success: '#2e7d32', error: '#e74c3c', running: '#f39c12' };

        container.innerHTML =
          '<table class="admin-table" style="margin:0; font-size:12px;">' +
            '<thead><tr><th>Date</th><th>Board</th><th>Section</th><th>Status</th><th>Items</th><th>New</th><th>Updated</th></tr></thead>' +
            '<tbody>' +
              logs.slice(0, 15).map(log =>
                '<tr>' +
                '<td style="white-space:nowrap;">' + new Date(log.started_at).toLocaleString() + '</td>' +
                '<td><code style="font-size:11px;">' + escHtml(log.board_name || log.board_id) + '</code></td>' +
                '<td>' + escHtml(log.target_section || 'pipeline') + '</td>' +
                '<td><span style="color:' + (statusColors[log.status] || '#888') + '; font-weight:600;">' + escHtml(log.status) + '</span></td>' +
                '<td>' + (log.items_synced || 0) + '</td>' +
                '<td>' + (log.items_created || 0) + '</td>' +
                '<td>' + (log.items_updated || 0) + '</td>' +
                '</tr>'
              ).join('') +
            '</tbody>' +
          '</table>';
      } catch (e) {
        container.textContent = 'Could not load sync history.';
      }
    }

    document.getElementById('mondayRunSyncBtn').addEventListener('click', runMondaySync);

    /* ── Init ── */
    document.addEventListener('DOMContentLoaded', () => {
      // Verify admin access
      api('/me').then(me => {
        if (!me || String(me.role).toLowerCase() !== 'admin') {
          document.body.innerHTML = '<div style="text-align:center; padding:80px 20px; color:#e74c3c;"><i class="fas fa-lock" style="font-size:48px; margin-bottom:12px; display:block;"></i><p style="font-size:16px;">Admin access required.</p></div>';
          return;
        }

        // Hash-based deep linking
        if (window.location.hash === '#monday') {
          document.querySelector('[data-tab="monday"]').click();
        } else {
          loadUsers();
        }
      });
    });
  })();
  </script>
</body>
</html>
