<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Settings - MSFG</title>

  <link rel="stylesheet" href="admin-styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/vendor/fontawesome/css/all.min.css" />
</head>

<body>
  <div class="pageHeader">
    <h2 id="pageTitle"><i class="fas fa-cog"></i> Admin Settings</h2>
  </div>

  <!-- Tab Navigation -->
  <div class="admin-tabs">
    <button class="admin-tab active" data-tab="employees">
      <i class="fas fa-users"></i> Employees
    </button>
    <button class="admin-tab" data-tab="investors">
      <i class="fas fa-landmark"></i> Investors
    </button>
    <button class="admin-tab" data-tab="forms">
      <i class="fas fa-file-upload"></i> Forms Library
    </button>
    <button class="admin-tab" data-tab="system">
      <i class="fas fa-server"></i> System
    </button>
    <button class="admin-tab" data-tab="monday">
      <i class="fas fa-sync-alt"></i> Monday.com
    </button>
  </div>

  <!-- ================================================
       TAB: Employees
  ================================================ -->
  <div class="admin-panel active" id="panel-employees">
    <div class="toolbar">
      <h3 style="margin:0; font-size:16px; color:#104547;">
        <i class="fas fa-users"></i> Employee Management
      </h3>
      <div class="toolbar-right">
        <button class="btn btn-primary" id="addUserBtn">
          <i class="fas fa-plus"></i> Add Employee
        </button>
      </div>
    </div>

    <!-- Add/Edit Form -->
    <div class="admin-form" id="userForm">
      <h4 style="margin:0 0 14px; font-size:14px;" id="userFormTitle">Add Employee</h4>
      <div class="form-grid">
        <div class="form-group">
          <label for="userNameInput">Full Name</label>
          <input type="text" id="userNameInput" placeholder="John Doe" required />
        </div>
        <div class="form-group">
          <label for="userEmailInput">Email</label>
          <input type="email" id="userEmailInput" placeholder="john@msfgco.com" required />
        </div>
        <div class="form-group">
          <label for="userInitialsInput">Initials</label>
          <input type="text" id="userInitialsInput" placeholder="JD" maxlength="3" />
        </div>
        <div class="form-group">
          <label for="userRoleSelect">Role</label>
          <select id="userRoleSelect">
            <option value="user">User</option>
            <option value="lo">Loan Officer</option>
            <option value="processor">Processor</option>
            <option value="manager">Manager</option>
            <option value="admin">Admin</option>
          </select>
        </div>
      </div>
      <div class="form-actions">
        <button class="btn btn-secondary" id="userFormCancelBtn">Cancel</button>
        <button class="btn btn-primary" id="userFormSaveBtn">
          <i class="fas fa-save"></i> Save
        </button>
      </div>
    </div>

    <!-- Employee Profile Detail View (hidden by default) -->
    <div id="employeeProfileView" style="display:none;">
      <div class="toolbar">
        <h3 style="margin:0; font-size:16px; color:#104547;">
          <i class="fas fa-arrow-left" id="profileBackBtn" style="cursor:pointer; margin-right:8px;" title="Back to list"></i>
          <span id="profileTitle">Employee Profile</span>
        </h3>
      </div>

      <!-- Profile Sub-Tabs -->
      <div class="profile-tabs" id="profileTabs">
        <button class="profile-tab active" data-ptab="basic"><i class="fas fa-user"></i> Basic Info</button>
        <button class="profile-tab" data-ptab="social"><i class="fas fa-share-alt"></i> Social</button>
        <button class="profile-tab" data-ptab="ai"><i class="fas fa-robot"></i> AI Keys</button>
        <button class="profile-tab" data-ptab="signature"><i class="fas fa-envelope"></i> Signature</button>
        <button class="profile-tab" data-ptab="notes"><i class="fas fa-sticky-note"></i> Notes</button>
        <button class="profile-tab" data-ptab="documents"><i class="fas fa-folder-open"></i> Documents</button>
      </div>

      <!-- ── SUB-TAB: Basic Info ── -->
      <div class="profile-section active" id="ptab-basic">
        <div style="display:flex; gap:24px; align-items:flex-start;">
          <!-- Avatar -->
          <div style="flex-shrink:0; text-align:center; min-width:140px;">
            <div class="avatar-container" id="profileAvatar">
              <img id="profileAvatarImg" src="" alt="" style="display:none; width:120px; height:120px; border-radius:50%; object-fit:cover;" />
              <div id="profileAvatarInitials" class="avatar-initials"></div>
            </div>
            <div style="margin-top:8px; display:flex; gap:4px; justify-content:center;">
              <button class="btn btn-sm btn-secondary" id="avatarUploadBtn"><i class="fas fa-camera"></i> Upload</button>
              <button class="btn btn-sm btn-danger" id="avatarRemoveBtn" style="display:none;"><i class="fas fa-trash"></i></button>
            </div>
            <input type="file" id="avatarFileInput" accept="image/*" style="display:none;" />
            <p id="profileNameDisplay" style="font-size:16px; font-weight:700; margin:12px 0 0; color:#104547;"></p>
            <p id="profileRoleDisplay" style="font-size:12px; color:#888; margin:2px 0;"></p>
            <p id="profileEmailDisplay" style="font-size:12px; color:#888; margin:0;"></p>
          </div>
          <!-- Editable Fields -->
          <div style="flex:1;">
            <div class="form-grid">
              <div class="form-group">
                <label>Team</label>
                <input type="text" id="profileTeam" placeholder="e.g. Sales, Operations" />
              </div>
              <div class="form-group">
                <label>Phone</label>
                <input type="tel" id="profilePhone" placeholder="(555) 123-4567" />
              </div>
              <div class="form-group">
                <label>Display Email</label>
                <input type="email" id="profileDisplayEmail" placeholder="public-facing email" />
              </div>
              <div class="form-group">
                <label>Website</label>
                <input type="url" id="profileWebsite" placeholder="https://..." />
              </div>
              <div class="form-group" style="grid-column: 1 / -1;">
                <label>Online Application URL</label>
                <input type="url" id="profileOnlineApp" placeholder="https://apply.msfgco.com/..." />
              </div>
            </div>
            <div class="form-actions">
              <button class="btn btn-primary" id="profileBasicSaveBtn"><i class="fas fa-save"></i> Save</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ── SUB-TAB: Social Media ── -->
      <div class="profile-section" id="ptab-social">
        <div class="form-grid">
          <div class="form-group">
            <label><i class="fab fa-facebook" style="color:#1877F2;"></i> Facebook</label>
            <input type="url" id="profileFacebook" placeholder="https://facebook.com/..." />
          </div>
          <div class="form-group">
            <label><i class="fab fa-instagram" style="color:#E4405F;"></i> Instagram</label>
            <input type="url" id="profileInstagram" placeholder="https://instagram.com/..." />
          </div>
          <div class="form-group">
            <label><i class="fab fa-twitter" style="color:#1DA1F2;"></i> Twitter / X</label>
            <input type="url" id="profileTwitter" placeholder="https://x.com/..." />
          </div>
          <div class="form-group">
            <label><i class="fab fa-linkedin" style="color:#0A66C2;"></i> LinkedIn</label>
            <input type="url" id="profileLinkedin" placeholder="https://linkedin.com/in/..." />
          </div>
          <div class="form-group">
            <label><i class="fab fa-tiktok"></i> TikTok</label>
            <input type="url" id="profileTiktok" placeholder="https://tiktok.com/@..." />
          </div>
        </div>
        <div class="form-actions">
          <button class="btn btn-primary" id="profileSocialSaveBtn"><i class="fas fa-save"></i> Save</button>
        </div>
      </div>

      <!-- ── SUB-TAB: AI Keys ── -->
      <div class="profile-section" id="ptab-ai">
        <div class="monday-section">
          <h4 style="margin:0 0 8px; font-size:14px; color:#104547;">
            <i class="fas fa-brain" style="color:#10a37f;"></i> ChatGPT (OpenAI) API Key
          </h4>
          <p id="aiOpenaiStatus" style="font-size:13px; color:#888; margin:0 0 8px;">Checking...</p>
          <div style="display:flex; gap:8px; align-items:center;">
            <input type="password" id="aiOpenaiInput" placeholder="sk-..." style="flex:1; padding:8px 12px; border:1px solid #ddd; border-radius:8px; font-family:inherit; font-size:13px;" />
            <button class="btn btn-primary btn-sm" id="aiOpenaiSaveBtn"><i class="fas fa-save"></i> Save</button>
            <button class="btn btn-danger btn-sm" id="aiOpenaiClearBtn"><i class="fas fa-trash"></i></button>
          </div>
        </div>
        <div class="monday-section">
          <h4 style="margin:0 0 8px; font-size:14px; color:#104547;">
            <i class="fas fa-robot" style="color:#d97706;"></i> Claude (Anthropic) API Key
          </h4>
          <p id="aiAnthropicStatus" style="font-size:13px; color:#888; margin:0 0 8px;">Checking...</p>
          <div style="display:flex; gap:8px; align-items:center;">
            <input type="password" id="aiAnthropicInput" placeholder="sk-ant-..." style="flex:1; padding:8px 12px; border:1px solid #ddd; border-radius:8px; font-family:inherit; font-size:13px;" />
            <button class="btn btn-primary btn-sm" id="aiAnthropicSaveBtn"><i class="fas fa-save"></i> Save</button>
            <button class="btn btn-danger btn-sm" id="aiAnthropicClearBtn"><i class="fas fa-trash"></i></button>
          </div>
        </div>
      </div>

      <!-- ── SUB-TAB: Email Signature ── -->
      <div class="profile-section" id="ptab-signature">
        <div class="form-group">
          <label>Email Signature (HTML)</label>
          <textarea id="profileSignatureInput" rows="12"
            style="width:100%; font-family:'Courier New',monospace; font-size:12px; padding:12px; border:1px solid #ddd; border-radius:8px; resize:vertical;"
            placeholder="Paste your HTML email signature here..."></textarea>
        </div>
        <div class="form-actions">
          <button class="btn btn-secondary" id="signaturePreviewBtn"><i class="fas fa-eye"></i> Preview</button>
          <button class="btn btn-primary" id="signatureSaveBtn"><i class="fas fa-save"></i> Save</button>
        </div>
        <div id="signaturePreview" style="display:none; margin-top:16px; padding:16px; border:1px solid #eee; border-radius:8px; background:#fff;">
          <h4 style="margin:0 0 8px; font-size:11px; color:#999; text-transform:uppercase; letter-spacing:.5px;">Preview</h4>
          <div id="signaturePreviewContent"></div>
        </div>
      </div>

      <!-- ── SUB-TAB: Notes ── -->
      <div class="profile-section" id="ptab-notes">
        <div style="margin-bottom:16px;">
          <textarea id="noteInput" rows="3"
            style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-family:inherit; font-size:13px; resize:vertical;"
            placeholder="Add a note about this employee..."></textarea>
          <div style="display:flex; justify-content:flex-end; margin-top:8px;">
            <button class="btn btn-primary btn-sm" id="addNoteBtn"><i class="fas fa-plus"></i> Add Note</button>
          </div>
        </div>
        <div id="notesList">
          <p style="text-align:center; color:#999; font-size:13px;">No notes yet.</p>
        </div>
      </div>

      <!-- ── SUB-TAB: Documents ── -->
      <div class="profile-section" id="ptab-documents">
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
          <select id="docCategoryUpload" style="padding:8px 12px; border:1px solid #ddd; border-radius:8px; font-family:inherit; font-size:13px;">
            <option value="">No Category</option>
            <option value="Contract">Contract</option>
            <option value="Performance Review">Performance Review</option>
            <option value="License">License</option>
            <option value="Training">Training</option>
            <option value="Other">Other</option>
          </select>
          <input type="text" id="docDescriptionInput" placeholder="Description (optional)" style="flex:1; padding:8px 12px; border:1px solid #ddd; border-radius:8px; font-family:inherit; font-size:13px;" />
        </div>

        <div class="upload-zone" id="docUploadZone">
          <i class="fas fa-cloud-upload-alt"></i>
          <p>Drop files here or click to browse</p>
          <span class="upload-hint">PDF, DOC, XLSX, images — contracts, performance reports, etc.</span>
        </div>
        <input type="file" id="docFileInput" multiple style="display:none;" />

        <div class="upload-progress" id="docUploadProgress">
          <p id="docUploadStatusText" style="font-size:13px; margin:0 0 6px;">Uploading...</p>
          <div class="upload-progress-bar">
            <div class="upload-progress-fill" id="docUploadProgressFill"></div>
          </div>
        </div>

        <table class="admin-table" id="documentsTable" style="margin-top:16px;">
          <thead>
            <tr>
              <th>File</th>
              <th>Category</th>
              <th>Size</th>
              <th>Uploaded By</th>
              <th>Date</th>
              <th style="width:100px;">Actions</th>
            </tr>
          </thead>
          <tbody id="documentsBody">
            <tr><td colspan="6" style="text-align:center; padding:20px; color:#999;">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <table class="admin-table" id="usersTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Status</th>
          <th style="width:180px;">Actions</th>
        </tr>
      </thead>
      <tbody id="usersBody">
        <tr><td colspan="5" class="state-msg"><i class="fas fa-spinner fa-spin"></i><p>Loading...</p></td></tr>
      </tbody>
    </table>
  </div>

  <!-- ================================================
       TAB: Investors
  ================================================ -->
  <div class="admin-panel" id="panel-investors">
    <div class="toolbar" id="investorListToolbar">
      <h3 style="margin:0; font-size:16px; color:#104547;">
        <i class="fas fa-landmark"></i> Investor Database
      </h3>
      <div class="toolbar-right">
        <button class="btn btn-primary" id="addInvestorBtn">
          <i class="fas fa-plus"></i> Add Investor
        </button>
      </div>
    </div>

    <!-- Add/Edit Form (quick create) -->
    <div class="admin-form" id="investorQuickForm">
      <h4 style="margin:0 0 14px; font-size:14px;" id="investorQuickFormTitle">Add Investor</h4>
      <div class="form-grid">
        <div class="form-group">
          <label for="invNameInput">Investor Name</label>
          <input type="text" id="invNameInput" placeholder="e.g. Pennymac" required />
        </div>
        <div class="form-group">
          <label for="invAeNameInput">Account Executive</label>
          <input type="text" id="invAeNameInput" placeholder="Name" />
        </div>
      </div>
      <div class="form-actions">
        <button class="btn btn-secondary" id="invQuickCancelBtn">Cancel</button>
        <button class="btn btn-primary" id="invQuickSaveBtn"><i class="fas fa-save"></i> Save</button>
      </div>
    </div>

    <table class="admin-table" id="investorsTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Account Executive</th>
          <th>States</th>
          <th>Best Programs</th>
          <th style="width:140px;">Actions</th>
        </tr>
      </thead>
      <tbody id="investorsBody">
        <tr><td colspan="5" class="state-msg"><i class="fas fa-spinner fa-spin"></i><p>Loading...</p></td></tr>
      </tbody>
    </table>

    <!-- Investor Profile Detail View (hidden by default) -->
    <div id="investorProfileView" style="display:none;">
      <div class="toolbar">
        <h3 style="margin:0; font-size:16px; color:#104547;">
          <i class="fas fa-arrow-left" id="invProfileBackBtn" style="cursor:pointer; margin-right:8px;" title="Back to list"></i>
          <span id="invProfileTitle">Investor Profile</span>
        </h3>
      </div>

      <!-- Investor Sub-Tabs -->
      <div class="profile-tabs" id="invProfileTabs">
        <button class="profile-tab active" data-inv-tab="inv-basic"><i class="fas fa-info-circle"></i> Basic Info</button>
        <button class="profile-tab" data-inv-tab="inv-team"><i class="fas fa-users"></i> Team</button>
        <button class="profile-tab" data-inv-tab="inv-lender"><i class="fas fa-id-card"></i> Lender IDs</button>
        <button class="profile-tab" data-inv-tab="inv-clauses"><i class="fas fa-file-contract"></i> Mortgagee Clauses</button>
        <button class="profile-tab" data-inv-tab="inv-links"><i class="fas fa-link"></i> Links</button>
      </div>

      <!-- ── SUB-TAB: Basic Info ── -->
      <div class="inv-profile-section active" id="inv-basic">
        <div style="display:flex; gap:24px; align-items:flex-start;">
          <!-- Logo -->
          <div style="flex-shrink:0; text-align:center; min-width:160px;">
            <div class="avatar-container" id="invLogoContainer" style="width:140px; height:140px; border-radius:12px; cursor:pointer;" title="Click to upload logo">
              <img id="invProfileLogoImg" src="" alt="" style="display:none; width:140px; height:140px; border-radius:12px; object-fit:contain;" />
              <div id="invProfileLogoPlaceholder" style="font-size:14px; color:#999;"><i class="fas fa-building" style="font-size:36px; display:block; margin-bottom:6px;"></i>No Logo</div>
            </div>
            <div style="margin-top:8px; display:flex; gap:4px; justify-content:center;">
              <button class="btn btn-sm btn-secondary" id="invLogoUploadBtn2"><i class="fas fa-camera"></i> Upload</button>
              <button class="btn btn-sm btn-danger" id="invLogoRemoveBtn2" style="display:none;"><i class="fas fa-trash"></i></button>
            </div>
            <input type="file" id="invLogoFileInput2" accept="image/png,image/jpeg,image/svg+xml" style="display:none;" />
            <p id="invProfileName" style="font-size:16px; font-weight:700; margin:12px 0 0; color:#104547;"></p>
          </div>
          <!-- Editable Fields -->
          <div style="flex:1;">
            <div class="form-grid">
              <div class="form-group">
                <label>Investor Name</label>
                <input type="text" id="invEditName" />
              </div>
              <div class="form-group">
                <label>AE Name</label>
                <input type="text" id="invEditAeName" />
              </div>
              <div class="form-group">
                <label>AE Email</label>
                <input type="email" id="invEditAeEmail" />
              </div>
              <div class="form-group">
                <label>AE Phone</label>
                <input type="tel" id="invEditAePhone" />
              </div>
              <div class="form-group">
                <label>States</label>
                <input type="text" id="invEditStates" placeholder="e.g. CO, TX, FL" />
              </div>
              <div class="form-group">
                <label>Best Programs</label>
                <input type="text" id="invEditBestPrograms" />
              </div>
              <div class="form-group">
                <label>Minimum FICO</label>
                <input type="text" id="invEditMinFico" />
              </div>
              <div class="form-group">
                <label>In-house DPA</label>
                <input type="text" id="invEditDpa" />
              </div>
              <div class="form-group">
                <label>EPO</label>
                <input type="text" id="invEditEpo" />
              </div>
              <div class="form-group">
                <label>Max Comp</label>
                <input type="number" id="invEditMaxComp" step="0.01" />
              </div>
              <div class="form-group">
                <label>Doc Review for Wire Release</label>
                <input type="text" id="invEditDocReview" />
              </div>
              <div class="form-group">
                <label>Remote Closing Review</label>
                <input type="text" id="invEditRemoteClosing" />
              </div>
            </div>
            <div class="form-actions">
              <button class="btn btn-primary" id="invBasicSaveBtn"><i class="fas fa-save"></i> Save Basic Info</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ── SUB-TAB: Team ── -->
      <div class="inv-profile-section" id="inv-team">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
          <p style="margin:0; font-size:13px; color:#888;">Manage team members for this investor.</p>
          <button class="btn btn-sm btn-primary" id="invAddTeamMemberBtn"><i class="fas fa-plus"></i> Add Member</button>
        </div>
        <div id="invTeamRows"></div>
        <div class="form-actions">
          <button class="btn btn-primary" id="invTeamSaveBtn"><i class="fas fa-save"></i> Save Team</button>
        </div>
      </div>

      <!-- ── SUB-TAB: Lender IDs ── -->
      <div class="inv-profile-section" id="inv-lender">
        <div class="form-grid">
          <div class="form-group">
            <label>FHA Lender ID</label>
            <input type="text" id="invEditFhaId" placeholder="e.g. 12345-0000-0" />
          </div>
          <div class="form-group">
            <label>VA Lender ID</label>
            <input type="text" id="invEditVaId" placeholder="e.g. 678900" />
          </div>
        </div>
        <div class="form-actions">
          <button class="btn btn-primary" id="invLenderSaveBtn"><i class="fas fa-save"></i> Save Lender IDs</button>
        </div>
      </div>

      <!-- ── SUB-TAB: Mortgagee Clauses ── -->
      <div class="inv-profile-section" id="inv-clauses">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
          <p style="margin:0; font-size:13px; color:#888;">Manage mortgagee clauses for this investor.</p>
          <button class="btn btn-sm btn-primary" id="invAddClauseBtn"><i class="fas fa-plus"></i> Add Clause</button>
        </div>
        <div id="invClauseRows"></div>
        <div class="form-actions">
          <button class="btn btn-primary" id="invClausesSaveBtn"><i class="fas fa-save"></i> Save Clauses</button>
        </div>
      </div>

      <!-- ── SUB-TAB: Links ── -->
      <div class="inv-profile-section" id="inv-links">
        <div class="form-grid">
          <div class="form-group">
            <label>Website</label>
            <input type="url" id="invLinkWebsite" placeholder="https://..." />
          </div>
          <div class="form-group">
            <label>Login Portal</label>
            <input type="url" id="invLinkLogin" placeholder="https://..." />
          </div>
          <div class="form-group">
            <label>Flex Site</label>
            <input type="url" id="invLinkFlexSite" placeholder="https://..." />
          </div>
          <div class="form-group">
            <label>FAQ Page</label>
            <input type="url" id="invLinkFaq" placeholder="https://..." />
          </div>
          <div class="form-group">
            <label>Appraisal Video</label>
            <input type="url" id="invLinkAppraisal" placeholder="https://..." />
          </div>
          <div class="form-group">
            <label>New Scenarios (email)</label>
            <input type="text" id="invLinkScenarios" placeholder="mailto:..." />
          </div>
        </div>
        <div class="form-actions">
          <button class="btn btn-primary" id="invLinksSaveBtn"><i class="fas fa-save"></i> Save Links</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ================================================
       TAB: Forms Library Upload
  ================================================ -->
  <div class="admin-panel" id="panel-forms">
    <div class="toolbar">
      <h3 style="margin:0; font-size:16px; color:#104547;">
        <i class="fas fa-file-upload"></i> Upload to Forms Library
      </h3>
      <div class="toolbar-right">
        <div class="form-group" style="flex-direction:row; align-items:center; gap:8px;">
          <label style="white-space:nowrap; margin:0;">Folder:</label>
          <input type="text" id="uploadFolder" placeholder="e.g. Compliance/2025" style="width:200px;" />
        </div>
      </div>
    </div>

    <div class="upload-zone" id="uploadZone">
      <i class="fas fa-cloud-upload-alt"></i>
      <p>Drop files here or click to browse</p>
      <span class="upload-hint">PDF, DOC, XLSX, images — up to 50 MB</span>
    </div>
    <input type="file" id="fileInput" multiple style="display:none;" />

    <div class="upload-progress" id="uploadProgress">
      <p id="uploadStatusText" style="font-size:13px; margin:0 0 6px;">Uploading...</p>
      <div class="upload-progress-bar">
        <div class="upload-progress-fill" id="uploadProgressFill"></div>
      </div>
    </div>

    <div id="uploadResults"></div>

    <p style="color:#888; font-size:13px; margin-top:16px;">
      <i class="fas fa-info-circle"></i>
      Files are uploaded directly to the <strong>msfg-mortgage-documents-prod</strong> S3 bucket.
      They will appear in the Forms Library file browser immediately.
    </p>
  </div>

  <!-- ================================================
       TAB: System
  ================================================ -->
  <div class="admin-panel" id="panel-system">
    <div class="toolbar">
      <h3 style="margin:0; font-size:16px; color:#104547;">
        <i class="fas fa-server"></i> System Information
      </h3>
      <div class="toolbar-right">
        <button class="btn btn-secondary" id="refreshSystemBtn">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
      </div>
    </div>

    <div class="system-grid" id="systemGrid">
      <div class="system-card">
        <div class="system-card-label">Database</div>
        <div class="system-card-value" id="sysDb">--</div>
      </div>
      <div class="system-card">
        <div class="system-card-label">Active Users</div>
        <div class="system-card-value" id="sysUsers">--</div>
      </div>
      <div class="system-card">
        <div class="system-card-label">Investors</div>
        <div class="system-card-value" id="sysInvestors">--</div>
      </div>
      <div class="system-card">
        <div class="system-card-label">Uptime</div>
        <div class="system-card-value" id="sysUptime">--</div>
      </div>
      <div class="system-card">
        <div class="system-card-label">Environment</div>
        <div class="system-card-value" id="sysEnv">--</div>
      </div>
      <div class="system-card">
        <div class="system-card-label">Version</div>
        <div class="system-card-value" id="sysVersion">--</div>
      </div>
    </div>
  </div>

  <!-- ================================================
       TAB: Monday.com Integration
  ================================================ -->
  <div class="admin-panel" id="panel-monday">

    <!-- API Token -->
    <div class="monday-section">
      <div class="toolbar">
        <h3 style="margin:0; font-size:16px; color:#104547;">
          <i class="fas fa-key"></i> API Token
        </h3>
      </div>
      <p id="mondayTokenStatus" style="font-size:13px; color:#888; margin:0 0 8px;">Checking...</p>
      <div style="display:flex; gap:8px; align-items:center;">
        <input type="password" id="mondayTokenInput" placeholder="Paste your Monday.com API token" style="flex:1; padding:8px 12px; border:1px solid #ddd; border-radius:8px; font-size:13px;" />
        <button class="btn btn-primary btn-sm" id="mondaySaveTokenBtn"><i class="fas fa-save"></i> Save</button>
        <button class="btn btn-secondary btn-sm" id="mondayTestTokenBtn"><i class="fas fa-plug"></i> Test</button>
      </div>
    </div>

    <!-- Board Management -->
    <div class="monday-section">
      <div class="toolbar">
        <h3 style="margin:0; font-size:16px; color:#104547;">
          <i class="fas fa-th-large"></i> Registered Boards
        </h3>
        <div class="toolbar-right">
          <button class="btn btn-primary btn-sm" id="mondayAddBoardBtn"><i class="fas fa-plus"></i> Add Board</button>
        </div>
      </div>

      <!-- Add Board Form (hidden by default) -->
      <div class="admin-form" id="mondayBoardForm">
        <h4 style="margin:0 0 12px; font-size:14px;" id="mondayBoardFormTitle">Add Board</h4>
        <div class="form-grid">
          <div class="form-group">
            <label for="mondayBoardIdInput">Board ID</label>
            <input type="text" id="mondayBoardIdInput" placeholder="e.g. 3946783498" />
          </div>
          <div class="form-group">
            <label for="mondayBoardNameInput">Board Name</label>
            <input type="text" id="mondayBoardNameInput" placeholder="e.g. Purchase Pipeline" />
          </div>
          <div class="form-group">
            <label for="mondayBoardSectionSelect">Target Section</label>
            <select id="mondayBoardSectionSelect">
              <option value="pipeline">Loan Pipeline</option>
              <option value="pre_approvals">Pre-Approvals</option>
              <option value="funded_loans">Loans Funded</option>
            </select>
          </div>
        </div>
        <div class="form-actions">
          <button class="btn btn-secondary" id="mondayBoardFormCancelBtn">Cancel</button>
          <button class="btn btn-primary" id="mondayBoardFormSaveBtn"><i class="fas fa-save"></i> Save Board</button>
        </div>
      </div>

      <table class="admin-table" id="mondayBoardsTable">
        <thead>
          <tr>
            <th>Board ID</th>
            <th>Name</th>
            <th>Section</th>
            <th>Status</th>
            <th style="width:120px;">Actions</th>
          </tr>
        </thead>
        <tbody id="mondayBoardsBody">
          <tr><td colspan="5" class="state-msg"><i class="fas fa-spinner fa-spin"></i><p>Loading...</p></td></tr>
        </tbody>
      </table>
    </div>

    <!-- Column Mappings -->
    <div class="monday-section">
      <div class="toolbar">
        <h3 style="margin:0; font-size:16px; color:#104547;">
          <i class="fas fa-arrows-alt-h"></i> Column Mappings
        </h3>
      </div>
      <p style="font-size:13px; color:#888; margin:0 0 8px;">
        Select a board, load its columns from Monday.com, and map them to dashboard fields.
      </p>
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
        <select id="mondayMappingBoardSelect" style="padding:8px 12px; border:1px solid #ddd; border-radius:8px; font-size:13px; flex:1;">
          <option value="">Select a board...</option>
        </select>
        <button class="btn btn-secondary btn-sm" id="mondayLoadColumnsBtn"><i class="fas fa-download"></i> Load Columns</button>
      </div>
      <div id="mondayMappingsContainer"></div>
      <button class="btn btn-primary btn-sm" id="mondaySaveMappingsBtn" style="display:none; margin-top:8px;">
        <i class="fas fa-save"></i> Save Mappings
      </button>
    </div>

    <!-- Display Config -->
    <div class="monday-section">
      <div class="toolbar">
        <h3 style="margin:0; font-size:16px; color:#104547;">
          <i class="fas fa-table"></i> Pipeline Table Columns
        </h3>
      </div>
      <p style="font-size:13px; color:#888; margin:0 0 8px;">
        Choose which columns appear in the pipeline table, set custom labels, and reorder them.
      </p>
      <div id="mondayDisplayConfig">
        <p style="font-size:13px; color:#888;">Save column mappings first, then configure display here.</p>
      </div>
      <button class="btn btn-primary btn-sm" id="mondaySaveDisplayBtn" style="display:none; margin-top:8px;">
        <i class="fas fa-save"></i> Save Display Settings
      </button>
    </div>

    <!-- Sync Controls -->
    <div class="monday-section">
      <div class="toolbar">
        <h3 style="margin:0; font-size:16px; color:#104547;">
          <i class="fas fa-sync-alt"></i> Sync Controls
        </h3>
        <div class="toolbar-right">
          <button class="btn btn-primary btn-sm" id="mondayRunSyncBtn"><i class="fas fa-play"></i> Run Sync Now</button>
        </div>
      </div>
      <div id="mondaySyncInfo" style="font-size:13px; color:#888; margin-bottom:8px;">No syncs have been run yet.</div>

      <h4 style="font-size:14px; margin:16px 0 8px; color:#104547;"><i class="fas fa-history"></i> Sync History</h4>
      <div id="mondaySyncHistory" style="font-size:13px; color:#888;">Loading...</div>
    </div>
  </div>

  <script>
  (() => {
    'use strict';

    /* ── API Config ── */
    const API_BASE = window.location.protocol === 'https:'
      ? 'https://api.msfgco.com/api'
      : 'http://54.175.238.145:8080/api';

    function getAuthToken() {
      const cookieMatch = document.cookie.match(/(?:^|;\s*)auth_token=([^;]*)/);
      return (
        localStorage.getItem('auth_token') ||
        (cookieMatch ? decodeURIComponent(cookieMatch[1]) : null) ||
        sessionStorage.getItem('auth_token')
      );
    }

    async function api(path, opts = {}) {
      const token = getAuthToken();
      const headers = { ...(opts.headers || {}) };
      if (token) headers['Authorization'] = 'Bearer ' + token;
      if (!headers['Content-Type'] && opts.body && typeof opts.body === 'string') {
        headers['Content-Type'] = 'application/json';
      }

      const res = await fetch(API_BASE + path, { ...opts, headers });

      if (res.status === 401) {
        alert('Session expired. Please log in again.');
        return null;
      }
      if (res.status === 403) {
        alert('Admin access required.');
        return null;
      }
      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || res.statusText);
      }
      return res.json();
    }

    function escHtml(str) {
      if (!str) return '';
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }

    /* ── Tabs ── */
    document.querySelectorAll('.admin-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('panel-' + tab.dataset.tab).classList.add('active');

        // Load data on tab switch
        const tabName = tab.dataset.tab;
        if (tabName === 'employees') loadUsers();
        if (tabName === 'investors') loadInvestors();
        if (tabName === 'system') loadSystem();
        if (tabName === 'monday') loadMondayTab();
      });
    });

    /* ═══════════════════════════════════════
       EMPLOYEES TAB
    ═══════════════════════════════════════ */
    let editingUserId = null;

    async function loadUsers() {
      const tbody = document.getElementById('usersBody');
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:#999;"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';

      try {
        const users = await api('/admin/users');
        if (!users) return;

        if (users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:#999;">No users found.</td></tr>';
          return;
        }

        tbody.innerHTML = users.map(u => {
          const statusBadge = u.is_active
            ? '<span class="badge badge-active">Active</span>'
            : '<span class="badge badge-inactive">Inactive</span>';
          const roleBadge = u.role === 'admin'
            ? '<span class="badge badge-admin">' + escHtml(u.role) + '</span>'
            : escHtml(u.role || 'user');

          return (
            '<tr data-user-id="' + u.id + '">' +
            '<td><strong>' + escHtml(u.name) + '</strong></td>' +
            '<td>' + escHtml(u.email) + '</td>' +
            '<td>' + roleBadge + '</td>' +
            '<td>' + statusBadge + '</td>' +
            '<td>' +
              '<button class="btn btn-sm btn-primary view-profile-btn" data-id="' + u.id + '" title="View Profile"><i class="fas fa-id-card"></i></button> ' +
              '<button class="btn btn-sm btn-secondary edit-user-btn" data-id="' + u.id + '" title="Edit"><i class="fas fa-edit"></i></button> ' +
              (u.is_active
                ? '<button class="btn btn-sm btn-danger deactivate-user-btn" data-id="' + u.id + '" title="Deactivate"><i class="fas fa-user-slash"></i></button>'
                : '<button class="btn btn-sm btn-primary activate-user-btn" data-id="' + u.id + '" title="Activate"><i class="fas fa-user-check"></i></button>'
              ) +
            '</td>' +
            '</tr>'
          );
        }).join('');

        // Bind view profile buttons
        tbody.querySelectorAll('.view-profile-btn').forEach(btn => {
          btn.addEventListener('click', () => showProfile(btn.dataset.id, users));
        });

        // Bind edit buttons
        tbody.querySelectorAll('.edit-user-btn').forEach(btn => {
          btn.addEventListener('click', () => editUser(users.find(u => String(u.id) === btn.dataset.id)));
        });

        // Bind deactivate buttons
        tbody.querySelectorAll('.deactivate-user-btn').forEach(btn => {
          btn.addEventListener('click', () => toggleUserActive(btn.dataset.id, false));
        });

        // Bind activate buttons
        tbody.querySelectorAll('.activate-user-btn').forEach(btn => {
          btn.addEventListener('click', () => toggleUserActive(btn.dataset.id, true));
        });
      } catch (err) {
        console.error('Load users error:', err);
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:#e74c3c;">Failed to load users.</td></tr>';
      }
    }

    function showUserForm(user) {
      const form = document.getElementById('userForm');
      const title = document.getElementById('userFormTitle');

      if (user) {
        editingUserId = user.id;
        title.textContent = 'Edit Employee';
        document.getElementById('userNameInput').value = user.name || '';
        document.getElementById('userEmailInput').value = user.email || '';
        document.getElementById('userEmailInput').disabled = true;
        document.getElementById('userInitialsInput').value = user.initials || '';
        document.getElementById('userRoleSelect').value = user.role || 'user';
      } else {
        editingUserId = null;
        title.textContent = 'Add Employee';
        document.getElementById('userNameInput').value = '';
        document.getElementById('userEmailInput').value = '';
        document.getElementById('userEmailInput').disabled = false;
        document.getElementById('userInitialsInput').value = '';
        document.getElementById('userRoleSelect').value = 'user';
      }

      form.classList.add('active');
    }

    function hideUserForm() {
      document.getElementById('userForm').classList.remove('active');
      editingUserId = null;
    }

    function editUser(user) {
      if (user) showUserForm(user);
    }

    async function saveUser() {
      const name = document.getElementById('userNameInput').value.trim();
      const email = document.getElementById('userEmailInput').value.trim();
      const initials = document.getElementById('userInitialsInput').value.trim();
      const role = document.getElementById('userRoleSelect').value;

      if (!name) return alert('Name is required');
      if (!editingUserId && !email) return alert('Email is required');

      try {
        if (editingUserId) {
          await api('/admin/users/' + editingUserId, {
            method: 'PUT',
            body: JSON.stringify({ name, initials, role }),
          });
        } else {
          await api('/admin/users', {
            method: 'POST',
            body: JSON.stringify({ email, name, initials, role }),
          });
        }

        hideUserForm();
        loadUsers();
      } catch (err) {
        alert('Error saving user: ' + err.message);
      }
    }

    async function toggleUserActive(userId, activate) {
      const action = activate ? 'activate' : 'deactivate';
      if (!confirm('Are you sure you want to ' + action + ' this user?')) return;

      try {
        if (activate) {
          await api('/admin/users/' + userId, {
            method: 'PUT',
            body: JSON.stringify({ is_active: true }),
          });
        } else {
          await api('/admin/users/' + userId, { method: 'DELETE' });
        }
        loadUsers();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Employee event listeners
    document.getElementById('addUserBtn').addEventListener('click', () => showUserForm(null));
    document.getElementById('userFormCancelBtn').addEventListener('click', hideUserForm);
    document.getElementById('userFormSaveBtn').addEventListener('click', saveUser);

    /* ═══════════════════════════════════════
       EMPLOYEE PROFILE VIEW
    ═══════════════════════════════════════ */
    let profileUserId = null;
    let profileUserObj = null;

    // --- Show / Hide Profile ---
    function showProfile(userId, users) {
      profileUserId = userId;
      profileUserObj = users ? users.find(u => String(u.id) === String(userId)) : null;

      // Hide table + form, show profile view
      document.getElementById('usersTable').style.display = 'none';
      document.getElementById('userForm').classList.remove('active');
      document.getElementById('addUserBtn').parentElement.parentElement.style.display = 'none';
      document.getElementById('employeeProfileView').style.display = 'block';

      // Set header
      document.getElementById('profileTitle').textContent = (profileUserObj ? profileUserObj.name : 'Employee') + ' — Profile';

      // Reset to Basic Info tab
      document.querySelectorAll('#profileTabs .profile-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('#employeeProfileView .profile-section').forEach(p => p.classList.remove('active'));
      document.querySelector('[data-ptab="basic"]').classList.add('active');
      document.getElementById('ptab-basic').classList.add('active');

      // Set static display info
      if (profileUserObj) {
        document.getElementById('profileNameDisplay').textContent = profileUserObj.name || '';
        document.getElementById('profileRoleDisplay').textContent = (profileUserObj.role || 'user').toUpperCase();
        document.getElementById('profileEmailDisplay').textContent = profileUserObj.email || '';
        document.getElementById('profileAvatarInitials').textContent = profileUserObj.initials || profileUserObj.name?.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) || '';
      }

      loadProfileData();
    }

    function hideProfile() {
      document.getElementById('employeeProfileView').style.display = 'none';
      document.getElementById('usersTable').style.display = '';
      document.getElementById('addUserBtn').parentElement.parentElement.style.display = '';
      profileUserId = null;
      profileUserObj = null;
    }

    // Back button
    document.getElementById('profileBackBtn').addEventListener('click', hideProfile);

    // Profile sub-tab switching (scoped to employee profile)
    document.querySelectorAll('#profileTabs .profile-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('#profileTabs .profile-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('#employeeProfileView .profile-section').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('ptab-' + tab.dataset.ptab).classList.add('active');

        // Lazy-load data per tab
        const t = tab.dataset.ptab;
        if (t === 'notes') loadNotes();
        if (t === 'documents') loadDocuments();
        if (t === 'ai') loadAIKeys();
      });
    });

    // --- Load Profile Data ---
    async function loadProfileData() {
      try {
        const data = await api('/admin/users/' + profileUserId + '/profile');
        if (!data) return;

        // Basic fields
        document.getElementById('profileTeam').value = data.team || '';
        document.getElementById('profilePhone').value = data.phone || '';
        document.getElementById('profileDisplayEmail').value = data.display_email || '';
        document.getElementById('profileWebsite').value = data.website || '';
        document.getElementById('profileOnlineApp').value = data.online_app_url || '';

        // Social fields
        document.getElementById('profileFacebook').value = data.facebook_url || '';
        document.getElementById('profileInstagram').value = data.instagram_url || '';
        document.getElementById('profileTwitter').value = data.twitter_url || '';
        document.getElementById('profileLinkedin').value = data.linkedin_url || '';
        document.getElementById('profileTiktok').value = data.tiktok_url || '';

        // Email signature
        document.getElementById('profileSignatureInput').value = data.email_signature || '';
        document.getElementById('signaturePreview').style.display = 'none';

        // Avatar
        const img = document.getElementById('profileAvatarImg');
        const initials = document.getElementById('profileAvatarInitials');
        const removeBtn = document.getElementById('avatarRemoveBtn');
        if (data.avatar_url) {
          img.src = data.avatar_url;
          img.style.display = 'block';
          initials.style.display = 'none';
          removeBtn.style.display = '';
        } else {
          img.style.display = 'none';
          initials.style.display = '';
          removeBtn.style.display = 'none';
        }

        // AI keys status (inline in profile data)
        if (data.ai_keys) {
          updateAIStatus('openai', data.ai_keys.openai);
          updateAIStatus('anthropic', data.ai_keys.anthropic);
        }
      } catch (err) {
        console.error('Load profile error:', err);
      }
    }

    // --- Save Basic Info ---
    document.getElementById('profileBasicSaveBtn').addEventListener('click', async () => {
      try {
        await api('/admin/users/' + profileUserId + '/profile', {
          method: 'PUT',
          body: JSON.stringify({
            team: document.getElementById('profileTeam').value.trim(),
            phone: document.getElementById('profilePhone').value.trim(),
            display_email: document.getElementById('profileDisplayEmail').value.trim(),
            website: document.getElementById('profileWebsite').value.trim(),
            online_app_url: document.getElementById('profileOnlineApp').value.trim(),
          }),
        });
        alert('Basic info saved!');
      } catch (err) {
        alert('Error saving: ' + err.message);
      }
    });

    // --- Save Social ---
    document.getElementById('profileSocialSaveBtn').addEventListener('click', async () => {
      try {
        await api('/admin/users/' + profileUserId + '/profile', {
          method: 'PUT',
          body: JSON.stringify({
            facebook_url: document.getElementById('profileFacebook').value.trim(),
            instagram_url: document.getElementById('profileInstagram').value.trim(),
            twitter_url: document.getElementById('profileTwitter').value.trim(),
            linkedin_url: document.getElementById('profileLinkedin').value.trim(),
            tiktok_url: document.getElementById('profileTiktok').value.trim(),
          }),
        });
        alert('Social links saved!');
      } catch (err) {
        alert('Error saving: ' + err.message);
      }
    });

    // --- Avatar Upload ---
    document.getElementById('avatarUploadBtn').addEventListener('click', () => {
      document.getElementById('avatarFileInput').click();
    });

    document.getElementById('avatarFileInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      if (!file.type.startsWith('image/')) return alert('Please select an image file');
      if (file.size > 5 * 1024 * 1024) return alert('Image must be under 5 MB');

      try {
        // 1. Get presigned URL
        const urlData = await api('/admin/users/' + profileUserId + '/avatar/upload-url', {
          method: 'POST',
          body: JSON.stringify({ fileName: file.name, fileType: file.type }),
        });
        if (!urlData) return;

        // 2. Upload to S3
        const uploadRes = await fetch(urlData.uploadUrl, {
          method: 'PUT',
          headers: { 'Content-Type': file.type },
          body: file,
        });
        if (!uploadRes.ok) throw new Error('Upload to S3 failed');

        // 3. Confirm
        await api('/admin/users/' + profileUserId + '/avatar/confirm', {
          method: 'PUT',
          body: JSON.stringify({ fileKey: urlData.fileKey }),
        });

        // 4. Show preview
        const reader = new FileReader();
        reader.onload = (ev) => {
          document.getElementById('profileAvatarImg').src = ev.target.result;
          document.getElementById('profileAvatarImg').style.display = 'block';
          document.getElementById('profileAvatarInitials').style.display = 'none';
          document.getElementById('avatarRemoveBtn').style.display = '';
        };
        reader.readAsDataURL(file);
      } catch (err) {
        alert('Avatar upload failed: ' + err.message);
      }

      e.target.value = ''; // reset file input
    });

    // --- Avatar Remove ---
    document.getElementById('avatarRemoveBtn').addEventListener('click', async () => {
      if (!confirm('Remove profile picture?')) return;
      try {
        await api('/admin/users/' + profileUserId + '/avatar', { method: 'DELETE' });
        document.getElementById('profileAvatarImg').style.display = 'none';
        document.getElementById('profileAvatarInitials').style.display = '';
        document.getElementById('avatarRemoveBtn').style.display = 'none';
      } catch (err) {
        alert('Error: ' + err.message);
      }
    });

    // --- Email Signature ---
    document.getElementById('signaturePreviewBtn').addEventListener('click', () => {
      const html = document.getElementById('profileSignatureInput').value;
      const preview = document.getElementById('signaturePreview');
      document.getElementById('signaturePreviewContent').innerHTML = html;
      preview.style.display = preview.style.display === 'none' ? 'block' : 'none';
    });

    document.getElementById('signatureSaveBtn').addEventListener('click', async () => {
      try {
        await api('/admin/users/' + profileUserId + '/profile', {
          method: 'PUT',
          body: JSON.stringify({
            email_signature: document.getElementById('profileSignatureInput').value,
          }),
        });
        alert('Signature saved!');
      } catch (err) {
        alert('Error saving: ' + err.message);
      }
    });

    // --- AI Keys ---
    function updateAIStatus(service, data) {
      const statusEl = document.getElementById('ai' + service.charAt(0).toUpperCase() + service.slice(1) + 'Status');
      if (!statusEl) return;
      // Map service names for display
      const sId = service === 'openai' ? 'Openai' : 'Anthropic';
      const el = document.getElementById('ai' + sId + 'Status');
      if (!el) return;
      if (data && data.maskedValue) {
        el.innerHTML = '<span style="color:#2e7d32;"><i class="fas fa-check-circle"></i> Configured</span> — ' + escHtml(data.maskedValue);
      } else {
        el.innerHTML = '<span style="color:#999;"><i class="fas fa-times-circle"></i> Not configured</span>';
      }
    }

    async function loadAIKeys() {
      try {
        const keys = await api('/admin/users/' + profileUserId + '/integrations');
        if (!keys) return;

        // Reset both
        updateAIStatus('openai', null);
        updateAIStatus('anthropic', null);

        keys.forEach(k => updateAIStatus(k.service, k));
      } catch (err) {
        console.error('Load AI keys error:', err);
      }
    }

    async function saveAIKey(service) {
      const inputId = service === 'openai' ? 'aiOpenaiInput' : 'aiAnthropicInput';
      const value = document.getElementById(inputId).value.trim();
      if (!value) return alert('Please enter an API key');

      try {
        const result = await api('/admin/users/' + profileUserId + '/integrations', {
          method: 'POST',
          body: JSON.stringify({ service, value }),
        });
        if (result) {
          document.getElementById(inputId).value = '';
          loadAIKeys();
          alert('API key saved!');
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function clearAIKey(service) {
      if (!confirm('Remove this API key?')) return;
      try {
        await api('/admin/users/' + profileUserId + '/integrations/' + service, { method: 'DELETE' });
        loadAIKeys();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    document.getElementById('aiOpenaiSaveBtn').addEventListener('click', () => saveAIKey('openai'));
    document.getElementById('aiOpenaiClearBtn').addEventListener('click', () => clearAIKey('openai'));
    document.getElementById('aiAnthropicSaveBtn').addEventListener('click', () => saveAIKey('anthropic'));
    document.getElementById('aiAnthropicClearBtn').addEventListener('click', () => clearAIKey('anthropic'));

    // --- Notes ---
    async function loadNotes() {
      const container = document.getElementById('notesList');
      container.innerHTML = '<p style="text-align:center; color:#999; font-size:13px;"><i class="fas fa-spinner fa-spin"></i> Loading...</p>';

      try {
        const notes = await api('/admin/users/' + profileUserId + '/notes');
        if (!notes) return;

        if (notes.length === 0) {
          container.innerHTML = '<p style="text-align:center; color:#999; font-size:13px;">No notes yet.</p>';
          return;
        }

        container.innerHTML = notes.map(n => {
          const date = new Date(n.created_at);
          const dateStr = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })
            + ' at ' + date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
          return (
            '<div class="note-card" data-note-id="' + n.id + '">' +
              '<div class="note-header">' +
                '<span class="note-author">' + escHtml(n.author_name) + '</span>' +
                '<span class="note-date">' + escHtml(dateStr) + '</span>' +
                '<button class="btn btn-sm btn-danger delete-note-btn" data-id="' + n.id + '" title="Delete"><i class="fas fa-trash"></i></button>' +
              '</div>' +
              '<div class="note-body">' + escHtml(n.note) + '</div>' +
            '</div>'
          );
        }).join('');

        container.querySelectorAll('.delete-note-btn').forEach(btn => {
          btn.addEventListener('click', () => deleteNote(btn.dataset.id));
        });
      } catch (err) {
        container.innerHTML = '<p style="text-align:center; color:#e74c3c; font-size:13px;">Failed to load notes.</p>';
      }
    }

    document.getElementById('addNoteBtn').addEventListener('click', async () => {
      const input = document.getElementById('noteInput');
      const note = input.value.trim();
      if (!note) return alert('Please enter a note');

      try {
        await api('/admin/users/' + profileUserId + '/notes', {
          method: 'POST',
          body: JSON.stringify({ note }),
        });
        input.value = '';
        loadNotes();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    });

    async function deleteNote(noteId) {
      if (!confirm('Delete this note?')) return;
      try {
        await api('/admin/users/' + profileUserId + '/notes/' + noteId, { method: 'DELETE' });
        loadNotes();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // --- Documents ---
    async function loadDocuments() {
      const tbody = document.getElementById('documentsBody');
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#999;"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';

      try {
        const docs = await api('/admin/users/' + profileUserId + '/documents');
        if (!docs) return;

        if (docs.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#999;">No documents uploaded yet.</td></tr>';
          return;
        }

        tbody.innerHTML = docs.map(d => {
          const date = new Date(d.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
          const size = d.file_size ? formatFileSize(d.file_size) : '—';
          const cat = d.category ? '<span class="doc-category">' + escHtml(d.category) + '</span>' : '—';
          return (
            '<tr>' +
              '<td><strong>' + escHtml(d.file_name) + '</strong>' +
                (d.description ? '<br><small style="color:#888;">' + escHtml(d.description) + '</small>' : '') +
              '</td>' +
              '<td>' + cat + '</td>' +
              '<td>' + escHtml(size) + '</td>' +
              '<td>' + escHtml(d.uploader_name) + '</td>' +
              '<td>' + escHtml(date) + '</td>' +
              '<td>' +
                '<button class="btn btn-sm btn-secondary download-doc-btn" data-id="' + d.id + '" title="Download"><i class="fas fa-download"></i></button> ' +
                '<button class="btn btn-sm btn-danger delete-doc-btn" data-id="' + d.id + '" title="Delete"><i class="fas fa-trash"></i></button>' +
              '</td>' +
            '</tr>'
          );
        }).join('');

        tbody.querySelectorAll('.download-doc-btn').forEach(btn => {
          btn.addEventListener('click', () => downloadDoc(btn.dataset.id));
        });
        tbody.querySelectorAll('.delete-doc-btn').forEach(btn => {
          btn.addEventListener('click', () => deleteDoc(btn.dataset.id));
        });
      } catch (err) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#e74c3c;">Failed to load documents.</td></tr>';
      }
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    async function downloadDoc(docId) {
      try {
        const data = await api('/admin/users/' + profileUserId + '/documents/' + docId + '/download-url');
        if (data && data.downloadUrl) {
          window.open(data.downloadUrl, '_blank');
        }
      } catch (err) {
        alert('Download error: ' + err.message);
      }
    }

    async function deleteDoc(docId) {
      if (!confirm('Delete this document? This cannot be undone.')) return;
      try {
        await api('/admin/users/' + profileUserId + '/documents/' + docId, { method: 'DELETE' });
        loadDocuments();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Document upload zone
    const docZone = document.getElementById('docUploadZone');
    const docInput = document.getElementById('docFileInput');

    docZone.addEventListener('click', () => docInput.click());
    docZone.addEventListener('dragover', (e) => { e.preventDefault(); docZone.classList.add('dragover'); });
    docZone.addEventListener('dragleave', () => docZone.classList.remove('dragover'));
    docZone.addEventListener('drop', (e) => {
      e.preventDefault();
      docZone.classList.remove('dragover');
      if (e.dataTransfer.files.length) handleDocUpload(e.dataTransfer.files);
    });
    docInput.addEventListener('change', (e) => {
      if (e.target.files.length) handleDocUpload(e.target.files);
      e.target.value = '';
    });

    async function handleDocUpload(files) {
      const progressEl = document.getElementById('docUploadProgress');
      const statusText = document.getElementById('docUploadStatusText');
      const fill = document.getElementById('docUploadProgressFill');
      const category = document.getElementById('docCategoryUpload').value;
      const description = document.getElementById('docDescriptionInput').value.trim();

      progressEl.style.display = 'block';
      const total = files.length;
      let done = 0;

      for (const file of files) {
        try {
          statusText.textContent = 'Uploading ' + file.name + ' (' + (done + 1) + '/' + total + ')...';
          fill.style.width = ((done / total) * 100) + '%';

          // 1. Get presigned URL
          const urlData = await api('/admin/users/' + profileUserId + '/documents/upload-url', {
            method: 'POST',
            body: JSON.stringify({ fileName: file.name, fileType: file.type }),
          });
          if (!urlData) continue;

          // 2. Upload to S3
          const uploadRes = await fetch(urlData.uploadUrl, {
            method: 'PUT',
            headers: { 'Content-Type': file.type || 'application/octet-stream' },
            body: file,
          });
          if (!uploadRes.ok) throw new Error('S3 upload failed for ' + file.name);

          // 3. Confirm
          await api('/admin/users/' + profileUserId + '/documents/confirm', {
            method: 'POST',
            body: JSON.stringify({
              fileKey: urlData.fileKey,
              fileName: file.name,
              fileType: file.type,
              fileSize: file.size,
              category: category || null,
              description: description || null,
            }),
          });

          done++;
          fill.style.width = ((done / total) * 100) + '%';
        } catch (err) {
          console.error('Upload error for', file.name, err);
          alert('Failed to upload ' + file.name + ': ' + err.message);
        }
      }

      statusText.textContent = done + ' of ' + total + ' files uploaded.';
      fill.style.width = '100%';
      setTimeout(() => { progressEl.style.display = 'none'; fill.style.width = '0'; }, 2000);

      // Clear description field
      document.getElementById('docDescriptionInput').value = '';

      loadDocuments();
    }

    /* ═══════════════════════════════════════
       INVESTORS TAB
    ═══════════════════════════════════════ */
    let investorsList = [];
    let currentInvestorId = null;
    let currentInvestorData = null;

    async function loadInvestors() {
      const tbody = document.getElementById('investorsBody');
      tbody.innerHTML = '<tr><td colspan="5" class="state-msg"><i class="fas fa-spinner fa-spin"></i><p>Loading...</p></td></tr>';

      try {
        const investors = await api('/investors');
        if (!investors) return;
        investorsList = investors;

        if (investors.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="state-msg"><p>No investors.</p></td></tr>';
          return;
        }

        tbody.innerHTML = investors.map(inv =>
          '<tr data-inv-id="' + inv.id + '">' +
          '<td><strong>' + escHtml(inv.name) + '</strong></td>' +
          '<td>' + escHtml(inv.account_executive_name || '--') + '</td>' +
          '<td>' + escHtml(inv.states || '--') + '</td>' +
          '<td>' + escHtml(inv.best_programs || '--') + '</td>' +
          '<td>' +
            '<button class="btn btn-sm btn-secondary inv-edit-btn" data-key="' + escHtml(inv.investor_key) + '" title="Edit"><i class="fas fa-pen"></i></button> ' +
            '<button class="btn btn-sm btn-danger inv-delete-btn" data-id="' + inv.id + '" data-name="' + escHtml(inv.name) + '" title="Delete"><i class="fas fa-trash"></i></button>' +
          '</td>' +
          '</tr>'
        ).join('');

        // Edit buttons → open profile
        tbody.querySelectorAll('.inv-edit-btn').forEach(btn => {
          btn.addEventListener('click', () => showInvestorProfile(btn.dataset.key));
        });

        // Delete buttons
        tbody.querySelectorAll('.inv-delete-btn').forEach(btn => {
          btn.addEventListener('click', () => deleteInvestor(btn.dataset.id, btn.dataset.name));
        });
      } catch (err) {
        console.error('Load investors error:', err);
        tbody.innerHTML = '<tr><td colspan="5" class="state-msg" style="color:#e74c3c;"><p>Failed to load investors.</p></td></tr>';
      }
    }

    // --- Quick Add / Edit form ---
    const invQuickForm = document.getElementById('investorQuickForm');
    const invQuickFormTitle = document.getElementById('investorQuickFormTitle');

    document.getElementById('addInvestorBtn').addEventListener('click', () => {
      document.getElementById('invNameInput').value = '';
      document.getElementById('invAeNameInput').value = '';
      invQuickFormTitle.textContent = 'Add Investor';
      invQuickForm.classList.add('active');
    });

    document.getElementById('invQuickCancelBtn').addEventListener('click', () => {
      invQuickForm.classList.remove('active');
    });

    document.getElementById('invQuickSaveBtn').addEventListener('click', async () => {
      const name = document.getElementById('invNameInput').value.trim();
      if (!name) return alert('Please enter an investor name.');

      try {
        await api('/investors', {
          method: 'POST',
          body: JSON.stringify({
            name: name,
            account_executive_name: document.getElementById('invAeNameInput').value.trim() || null,
          }),
        });
        invQuickForm.classList.remove('active');
        loadInvestors();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    });

    async function deleteInvestor(id, name) {
      if (!confirm('Delete investor "' + name + '"? This cannot be undone.')) return;
      try {
        await api('/investors/' + id, { method: 'DELETE' });
        loadInvestors();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // --- Investor Profile Detail View ---
    async function showInvestorProfile(investorKey) {
      try {
        const data = await api('/investors/' + encodeURIComponent(investorKey));
        if (!data) return;

        currentInvestorData = data;
        currentInvestorId = data.id;

        // Hide table, show profile
        document.getElementById('investorsTable').style.display = 'none';
        document.getElementById('investorListToolbar').style.display = 'none';
        invQuickForm.classList.remove('active');
        document.getElementById('investorProfileView').style.display = 'block';
        document.getElementById('invProfileTitle').textContent = data.name + ' — Profile';
        document.getElementById('invProfileName').textContent = data.name;

        // Reset sub-tabs to Basic Info
        document.querySelectorAll('#invProfileTabs .profile-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.inv-profile-section').forEach(p => p.classList.remove('active'));
        document.querySelector('[data-inv-tab="inv-basic"]').classList.add('active');
        document.getElementById('inv-basic').classList.add('active');

        // Populate Basic Info
        populateInvestorBasicInfo(data);

        // Populate sub-sections
        populateInvestorTeam(data.team || []);
        populateInvestorLenderIds(data.lenderIds || {});
        populateInvestorClauses(data.mortgageeClauses || []);
        populateInvestorLinks(data.links || []);

        // Logo
        loadInvestorLogo(data);
      } catch (err) {
        alert('Error loading investor: ' + err.message);
      }
    }

    function hideInvestorProfile() {
      document.getElementById('investorProfileView').style.display = 'none';
      document.getElementById('investorsTable').style.display = '';
      document.getElementById('investorListToolbar').style.display = '';
      currentInvestorId = null;
      currentInvestorData = null;
    }

    // Back button
    document.getElementById('invProfileBackBtn').addEventListener('click', () => {
      hideInvestorProfile();
      loadInvestors();
    });

    // Investor sub-tab switching (scoped to investor profile)
    document.querySelectorAll('#invProfileTabs .profile-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('#invProfileTabs .profile-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.inv-profile-section').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.invTab).classList.add('active');
      });
    });

    // --- Populate Basic Info ---
    function populateInvestorBasicInfo(data) {
      document.getElementById('invEditName').value = data.name || '';
      document.getElementById('invEditAeName').value = data.account_executive_name || '';
      document.getElementById('invEditAeEmail').value = data.account_executive_email || '';
      document.getElementById('invEditAePhone').value = data.account_executive_phone || '';
      document.getElementById('invEditStates').value = data.states || '';
      document.getElementById('invEditBestPrograms').value = data.best_programs || '';
      document.getElementById('invEditMinFico').value = data.min_fico || '';
      document.getElementById('invEditDpa').value = data.in_house_dpa || '';
      document.getElementById('invEditEpo').value = data.epo || '';
      document.getElementById('invEditMaxComp').value = data.max_comp ?? '';
      document.getElementById('invEditDocReview').value = data.doc_review_for_wire_release || '';
      document.getElementById('invEditRemoteClosing').value = data.remote_closing_review || '';
    }

    // Save Basic Info
    document.getElementById('invBasicSaveBtn').addEventListener('click', async () => {
      if (!currentInvestorId) return;
      try {
        await api('/investors/' + currentInvestorId, {
          method: 'PUT',
          body: JSON.stringify({
            name: document.getElementById('invEditName').value.trim(),
            account_executive_name: document.getElementById('invEditAeName').value.trim() || null,
            account_executive_email: document.getElementById('invEditAeEmail').value.trim() || null,
            account_executive_phone: document.getElementById('invEditAePhone').value.trim() || null,
            states: document.getElementById('invEditStates').value.trim() || null,
            best_programs: document.getElementById('invEditBestPrograms').value.trim() || null,
            min_fico: document.getElementById('invEditMinFico').value.trim() || null,
            in_house_dpa: document.getElementById('invEditDpa').value.trim() || null,
            epo: document.getElementById('invEditEpo').value.trim() || null,
            max_comp: document.getElementById('invEditMaxComp').value || null,
            doc_review_for_wire_release: document.getElementById('invEditDocReview').value.trim() || null,
            remote_closing_review: document.getElementById('invEditRemoteClosing').value.trim() || null,
          }),
        });
        document.getElementById('invProfileTitle').textContent = document.getElementById('invEditName').value.trim() + ' — Profile';
        document.getElementById('invProfileName').textContent = document.getElementById('invEditName').value.trim();
        alert('Basic info saved!');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    });

    // --- Logo ---
    function loadInvestorLogo(data) {
      const img = document.getElementById('invProfileLogoImg');
      const placeholder = document.getElementById('invProfileLogoPlaceholder');
      const removeBtn = document.getElementById('invLogoRemoveBtn2');

      if (data.logo_url) {
        img.src = data.logo_url;
        img.onerror = function() { this.onerror = null; this.src = '/assets/msfg-logo-fallback.svg'; };
        img.style.display = 'block';
        placeholder.style.display = 'none';
        removeBtn.style.display = '';
      } else {
        img.style.display = 'none';
        img.src = '';
        placeholder.style.display = '';
        removeBtn.style.display = 'none';
      }
    }

    document.getElementById('invLogoUploadBtn2').addEventListener('click', () => {
      document.getElementById('invLogoFileInput2').click();
    });

    document.getElementById('invLogoFileInput2').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file || !currentInvestorId) return;

      // Client-side validation
      const ALLOWED = ['image/png', 'image/jpeg', 'image/svg+xml'];
      if (!ALLOWED.includes(file.type)) {
        alert('Only PNG, JPG, and SVG images are allowed.');
        e.target.value = '';
        return;
      }
      if (file.size > 5 * 1024 * 1024) {
        alert('Logo must be under 5 MB.');
        e.target.value = '';
        return;
      }

      try {
        const { uploadUrl, fileKey } = await api('/investors/' + currentInvestorId + '/logo/upload-url', {
          method: 'POST',
          body: JSON.stringify({ fileName: file.name, fileType: file.type, fileSize: file.size }),
        });
        await fetch(uploadUrl, { method: 'PUT', headers: { 'Content-Type': file.type }, body: file });
        const result = await api('/investors/' + currentInvestorId + '/logo/confirm', {
          method: 'PUT',
          body: JSON.stringify({ fileKey }),
        });
        loadInvestorLogo({ logo_url: result.logo_url });
      } catch (err) {
        alert('Logo upload failed: ' + err.message);
      }
      e.target.value = '';
    });

    document.getElementById('invLogoRemoveBtn2').addEventListener('click', async () => {
      if (!currentInvestorId) return;
      if (!confirm('Remove logo?')) return;
      try {
        await api('/investors/' + currentInvestorId + '/logo', { method: 'DELETE' });
        loadInvestorLogo({});
      } catch (err) {
        alert('Error: ' + err.message);
      }
    });

    // --- Team ---
    function populateInvestorTeam(team) {
      const container = document.getElementById('invTeamRows');
      container.innerHTML = '';
      if (team.length === 0) {
        addTeamMemberRow(container);
        return;
      }
      team.forEach(m => addTeamMemberRow(container, m));
    }

    function addTeamMemberRow(container, data) {
      container = container || document.getElementById('invTeamRows');
      const row = document.createElement('div');
      row.className = 'inv-repeatable-row';
      row.innerHTML =
        '<input type="text" placeholder="Role" value="' + escHtml((data && data.role) || '') + '" data-field="role" />' +
        '<input type="text" placeholder="Name" value="' + escHtml((data && data.name) || '') + '" data-field="name" />' +
        '<input type="tel" placeholder="Phone" value="' + escHtml((data && data.phone) || '') + '" data-field="phone" />' +
        '<input type="email" placeholder="Email" value="' + escHtml((data && data.email) || '') + '" data-field="email" />' +
        '<button class="btn btn-sm btn-danger" title="Remove"><i class="fas fa-times"></i></button>';
      row.querySelector('button').addEventListener('click', () => row.remove());
      container.appendChild(row);
    }

    document.getElementById('invAddTeamMemberBtn').addEventListener('click', () => addTeamMemberRow());

    document.getElementById('invTeamSaveBtn').addEventListener('click', async () => {
      if (!currentInvestorId) return;
      const rows = document.querySelectorAll('#invTeamRows .inv-repeatable-row');
      const team = [];
      rows.forEach((row, i) => {
        const role = row.querySelector('[data-field="role"]').value.trim();
        const name = row.querySelector('[data-field="name"]').value.trim();
        const phone = row.querySelector('[data-field="phone"]').value.trim();
        const email = row.querySelector('[data-field="email"]').value.trim();
        if (name || role) team.push({ role, name, phone, email, sort_order: i });
      });
      try {
        await api('/investors/' + currentInvestorId + '/team', {
          method: 'PUT',
          body: JSON.stringify({ team }),
        });
        alert('Team saved!');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    });

    // --- Lender IDs ---
    function populateInvestorLenderIds(data) {
      document.getElementById('invEditFhaId').value = data.fha_id || '';
      document.getElementById('invEditVaId').value = data.va_id || '';
    }

    document.getElementById('invLenderSaveBtn').addEventListener('click', async () => {
      if (!currentInvestorId) return;
      try {
        await api('/investors/' + currentInvestorId + '/lender-ids', {
          method: 'PUT',
          body: JSON.stringify({
            fha_id: document.getElementById('invEditFhaId').value.trim() || null,
            va_id: document.getElementById('invEditVaId').value.trim() || null,
          }),
        });
        alert('Lender IDs saved!');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    });

    // --- Mortgagee Clauses ---
    function populateInvestorClauses(clauses) {
      const container = document.getElementById('invClauseRows');
      container.innerHTML = '';
      if (clauses.length === 0) {
        addClauseRow(container);
        return;
      }
      clauses.forEach(c => addClauseRow(container, c));
    }

    function addClauseRow(container, data) {
      container = container || document.getElementById('invClauseRows');
      const row = document.createElement('div');
      row.className = 'inv-repeatable-row inv-clause-row';
      row.innerHTML =
        '<input type="text" placeholder="Name" value="' + escHtml((data && data.name) || '') + '" data-field="name" />' +
        '<input type="text" placeholder="ISAOA" value="' + escHtml((data && data.isaoa) || '') + '" data-field="isaoa" />' +
        '<input type="text" placeholder="Address" value="' + escHtml((data && data.address) || '') + '" data-field="address" />' +
        '<button class="btn btn-sm btn-danger" title="Remove"><i class="fas fa-times"></i></button>';
      row.querySelector('button').addEventListener('click', () => row.remove());
      container.appendChild(row);
    }

    document.getElementById('invAddClauseBtn').addEventListener('click', () => addClauseRow());

    document.getElementById('invClausesSaveBtn').addEventListener('click', async () => {
      if (!currentInvestorId) return;
      const rows = document.querySelectorAll('#invClauseRows .inv-repeatable-row');
      const clauses = [];
      rows.forEach(row => {
        const name = row.querySelector('[data-field="name"]').value.trim();
        const isaoa = row.querySelector('[data-field="isaoa"]').value.trim();
        const address = row.querySelector('[data-field="address"]').value.trim();
        if (name) clauses.push({ name, isaoa, address });
      });
      try {
        await api('/investors/' + currentInvestorId + '/mortgagee-clauses', {
          method: 'PUT',
          body: JSON.stringify({ clauses }),
        });
        alert('Mortgagee clauses saved!');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    });

    // --- Links ---
    const LINK_FIELDS = [
      { type: 'website', id: 'invLinkWebsite' },
      { type: 'login', id: 'invLinkLogin' },
      { type: 'flex_site', id: 'invLinkFlexSite' },
      { type: 'faq', id: 'invLinkFaq' },
      { type: 'appraisal_video', id: 'invLinkAppraisal' },
      { type: 'new_scenarios', id: 'invLinkScenarios' },
    ];

    function populateInvestorLinks(links) {
      // Clear all
      LINK_FIELDS.forEach(f => { document.getElementById(f.id).value = ''; });
      // Fill from data
      links.forEach(link => {
        const field = LINK_FIELDS.find(f => f.type === link.link_type);
        if (field) document.getElementById(field.id).value = link.url || '';
      });
    }

    document.getElementById('invLinksSaveBtn').addEventListener('click', async () => {
      if (!currentInvestorId) return;
      const links = [];
      LINK_FIELDS.forEach(f => {
        const url = document.getElementById(f.id).value.trim();
        if (url) links.push({ link_type: f.type, url: url });
      });
      try {
        await api('/investors/' + currentInvestorId + '/links', {
          method: 'PUT',
          body: JSON.stringify({ links }),
        });
        alert('Links saved!');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    });

    // --- Hash routing for deep-link ---
    function checkInvestorHash() {
      const hash = window.location.hash;
      if (hash === '#investors') {
        // Switch to investors tab
        document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
        document.querySelector('[data-tab="investors"]').classList.add('active');
        document.getElementById('panel-investors').classList.add('active');
        loadInvestors();
      }
    }

    /* ═══════════════════════════════════════
       FORMS LIBRARY UPLOAD TAB
    ═══════════════════════════════════════ */
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');

    uploadZone.addEventListener('click', () => fileInput.click());

    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', () => {
      handleFiles(fileInput.files);
      fileInput.value = '';
    });

    async function handleFiles(files) {
      if (!files || files.length === 0) return;

      const folder = document.getElementById('uploadFolder').value.trim();
      const progressEl = document.getElementById('uploadProgress');
      const statusText = document.getElementById('uploadStatusText');
      const progressFill = document.getElementById('uploadProgressFill');
      const resultsEl = document.getElementById('uploadResults');

      progressEl.style.display = 'block';
      resultsEl.innerHTML = '';

      let completed = 0;
      const total = files.length;

      for (const file of files) {
        statusText.textContent = 'Uploading ' + file.name + ' (' + (completed + 1) + '/' + total + ')...';
        progressFill.style.width = ((completed / total) * 100) + '%';

        try {
          // Get presigned URL
          const urlData = await api('/admin/files/upload-url', {
            method: 'POST',
            body: JSON.stringify({
              fileName: file.name,
              fileType: file.type || 'application/octet-stream',
              folder: folder,
            }),
          });

          if (!urlData) continue;

          // Upload to S3
          const uploadRes = await fetch(urlData.uploadUrl, {
            method: 'PUT',
            headers: { 'Content-Type': file.type || 'application/octet-stream' },
            body: file,
          });

          if (!uploadRes.ok) throw new Error('Upload failed');

          resultsEl.innerHTML += '<p style="color:#2e7d32; font-size:13px;"><i class="fas fa-check-circle"></i> ' + escHtml(file.name) + ' uploaded successfully</p>';
        } catch (err) {
          resultsEl.innerHTML += '<p style="color:#e74c3c; font-size:13px;"><i class="fas fa-times-circle"></i> ' + escHtml(file.name) + ' failed: ' + escHtml(err.message) + '</p>';
        }

        completed++;
      }

      progressFill.style.width = '100%';
      statusText.textContent = 'Upload complete! ' + completed + '/' + total + ' files uploaded.';

      setTimeout(() => { progressEl.style.display = 'none'; }, 3000);
    }

    /* ═══════════════════════════════════════
       SYSTEM TAB
    ═══════════════════════════════════════ */
    async function loadSystem() {
      try {
        const info = await api('/admin/system');
        if (!info) return;

        const dbEl = document.getElementById('sysDb');
        dbEl.textContent = info.database === 'connected' ? 'Connected' : 'Error';
        dbEl.className = 'system-card-value ' + (info.database === 'connected' ? 'ok' : 'error');

        document.getElementById('sysUsers').textContent = info.activeUsers;
        document.getElementById('sysInvestors').textContent = info.totalInvestors;

        // Format uptime
        const hrs = Math.floor(info.uptime / 3600);
        const mins = Math.floor((info.uptime % 3600) / 60);
        document.getElementById('sysUptime').textContent = hrs + 'h ' + mins + 'm';

        document.getElementById('sysEnv').textContent = info.environment;
        document.getElementById('sysVersion').textContent = 'v' + info.version;
      } catch (err) {
        console.error('System info error:', err);
      }
    }

    document.getElementById('refreshSystemBtn').addEventListener('click', loadSystem);

    /* ═══════════════════════════════════════
       MONDAY.COM TAB
    ═══════════════════════════════════════ */
    let mondayBoards = [];
    let mondayBoardColumns = [];
    let mondayCurrentBoardId = null;
    let mondayEditingBoardId = null;

    function loadMondayTab() {
      loadMondayBoards();
      loadMondayTokenStatus();
      loadMondaySyncHistory();
      loadMondayDisplayConfig();
    }

    // ── Token Management ──
    async function loadMondayTokenStatus() {
      try {
        const integrations = await api('/integrations');
        if (!integrations) return;
        const monday = integrations.find(i => i.service === 'monday');
        const status = document.getElementById('mondayTokenStatus');
        if (monday) {
          status.textContent = 'Token configured (' + (monday.maskedValue || '***') + '). Last tested: ' + (monday.last_tested_at ? new Date(monday.last_tested_at).toLocaleString() : 'Never');
          status.style.color = '#2e7d32';
        } else {
          status.textContent = 'No token configured. Paste your Monday.com API token below.';
          status.style.color = '#f39c12';
        }
      } catch (e) { /* non-critical */ }
    }

    async function saveMondayToken() {
      const input = document.getElementById('mondayTokenInput');
      const value = input.value.trim();
      if (!value) return alert('Please enter a token.');
      try {
        await api('/integrations', {
          method: 'POST',
          body: JSON.stringify({ service: 'monday', credential_type: 'api_key', value: value, label: 'Monday.com API Token' }),
        });
        input.value = '';
        loadMondayTokenStatus();
        alert('Token saved!');
      } catch (err) { alert('Failed to save token: ' + err.message); }
    }

    async function testMondayToken() {
      const status = document.getElementById('mondayTokenStatus');
      status.textContent = 'Testing connection...';
      status.style.color = '#888';
      try {
        const result = await api('/integrations/monday/test', { method: 'POST', body: '{}' });
        if (result && result.success) {
          status.textContent = result.message || 'Connection successful!';
          status.style.color = '#2e7d32';
        } else {
          status.textContent = 'Test failed: ' + (result ? result.message : 'Unknown error');
          status.style.color = '#e74c3c';
        }
      } catch (err) {
        status.textContent = 'Test failed: ' + err.message;
        status.style.color = '#e74c3c';
      }
    }

    document.getElementById('mondaySaveTokenBtn').addEventListener('click', saveMondayToken);
    document.getElementById('mondayTestTokenBtn').addEventListener('click', testMondayToken);

    // ── Board Management ──
    async function loadMondayBoards() {
      const tbody = document.getElementById('mondayBoardsBody');
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#999;"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';

      try {
        const data = await api('/monday/boards');
        if (!data) return;
        mondayBoards = data.boards || [];

        if (mondayBoards.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#999;">No boards registered. Click "Add Board" to get started.</td></tr>';
          populateBoardSelect([]);
          return;
        }

        const sectionLabels = { pipeline: 'Loan Pipeline', pre_approvals: 'Pre-Approvals', funded_loans: 'Loans Funded' };
        const sectionClasses = { pipeline: 'section-pipeline', pre_approvals: 'section-preapprovals', funded_loans: 'section-funded' };

        tbody.innerHTML = mondayBoards.map(b =>
          '<tr data-board-id="' + escHtml(b.board_id) + '">' +
          '<td><code style="font-size:12px;">' + escHtml(b.board_id) + '</code></td>' +
          '<td><strong>' + escHtml(b.board_name || 'Unnamed') + '</strong></td>' +
          '<td><span class="badge ' + (sectionClasses[b.target_section] || '') + '">' + escHtml(sectionLabels[b.target_section] || b.target_section) + '</span></td>' +
          '<td>' + (b.is_active ? '<span class="badge badge-active">Active</span>' : '<span class="badge badge-inactive">Inactive</span>') + '</td>' +
          '<td>' +
            '<button class="btn btn-sm btn-secondary monday-edit-board" data-bid="' + escHtml(b.board_id) + '" title="Edit"><i class="fas fa-edit"></i></button> ' +
            '<button class="btn btn-sm btn-danger monday-delete-board" data-bid="' + escHtml(b.board_id) + '" title="Remove"><i class="fas fa-trash"></i></button>' +
          '</td>' +
          '</tr>'
        ).join('');

        // Bind edit buttons
        tbody.querySelectorAll('.monday-edit-board').forEach(btn => {
          btn.addEventListener('click', () => {
            const board = mondayBoards.find(b => b.board_id === btn.dataset.bid);
            if (board) showBoardForm(board);
          });
        });

        // Bind delete buttons
        tbody.querySelectorAll('.monday-delete-board').forEach(btn => {
          btn.addEventListener('click', () => deleteMondayBoard(btn.dataset.bid));
        });

        populateBoardSelect(mondayBoards);
      } catch (err) {
        console.error('Load boards error:', err);
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#e74c3c;">Failed to load boards.</td></tr>';
      }
    }

    function populateBoardSelect(boards) {
      const select = document.getElementById('mondayMappingBoardSelect');
      select.innerHTML = '<option value="">Select a board...</option>' +
        boards.map(b => '<option value="' + escHtml(b.board_id) + '">' + escHtml(b.board_name || b.board_id) + ' (' + escHtml(b.board_id) + ')</option>').join('');
    }

    function showBoardForm(board) {
      const form = document.getElementById('mondayBoardForm');
      const title = document.getElementById('mondayBoardFormTitle');
      if (board) {
        mondayEditingBoardId = board.board_id;
        title.textContent = 'Edit Board';
        document.getElementById('mondayBoardIdInput').value = board.board_id;
        document.getElementById('mondayBoardIdInput').disabled = true;
        document.getElementById('mondayBoardNameInput').value = board.board_name || '';
        document.getElementById('mondayBoardSectionSelect').value = board.target_section || 'pipeline';
      } else {
        mondayEditingBoardId = null;
        title.textContent = 'Add Board';
        document.getElementById('mondayBoardIdInput').value = '';
        document.getElementById('mondayBoardIdInput').disabled = false;
        document.getElementById('mondayBoardNameInput').value = '';
        document.getElementById('mondayBoardSectionSelect').value = 'pipeline';
      }
      form.classList.add('active');
    }

    function hideBoardForm() {
      document.getElementById('mondayBoardForm').classList.remove('active');
      mondayEditingBoardId = null;
    }

    async function saveMondayBoard() {
      const boardId = document.getElementById('mondayBoardIdInput').value.trim();
      const boardName = document.getElementById('mondayBoardNameInput').value.trim();
      const targetSection = document.getElementById('mondayBoardSectionSelect').value;

      if (!boardId) return alert('Board ID is required');

      try {
        if (mondayEditingBoardId) {
          await api('/monday/boards/' + mondayEditingBoardId, {
            method: 'PUT',
            body: JSON.stringify({ boardName, targetSection }),
          });
        } else {
          await api('/monday/boards', {
            method: 'POST',
            body: JSON.stringify({ boardId, boardName, targetSection }),
          });
        }
        hideBoardForm();
        loadMondayBoards();
      } catch (err) { alert('Error saving board: ' + err.message); }
    }

    async function deleteMondayBoard(boardId) {
      if (!confirm('Remove board ' + boardId + '? This will also delete its column mappings and sync history.')) return;
      try {
        await api('/monday/boards/' + boardId, { method: 'DELETE' });
        loadMondayBoards();
      } catch (err) { alert('Error removing board: ' + err.message); }
    }

    document.getElementById('mondayAddBoardBtn').addEventListener('click', () => showBoardForm(null));
    document.getElementById('mondayBoardFormCancelBtn').addEventListener('click', hideBoardForm);
    document.getElementById('mondayBoardFormSaveBtn').addEventListener('click', saveMondayBoard);

    // ── Column Mappings ──
    async function loadMondayColumns() {
      const boardId = document.getElementById('mondayMappingBoardSelect').value;
      if (!boardId) return alert('Please select a board first.');

      mondayCurrentBoardId = boardId;
      const container = document.getElementById('mondayMappingsContainer');
      const saveBtn = document.getElementById('mondaySaveMappingsBtn');
      container.innerHTML = '<p style="color:#888; font-size:13px;"><i class="fas fa-spinner fa-spin"></i> Loading columns from Monday.com...</p>';

      try {
        const data = await api('/monday/columns?board=' + boardId);
        if (!data) return;

        mondayBoardColumns = data.columns || [];
        const validFields = data.validPipelineFields || [];
        const fieldLabels = data.fieldLabels || {};
        const section = data.targetSection || 'pipeline';

        // Load existing mappings
        let existingMappings = {};
        try {
          const saved = await api('/monday/mappings?board=' + boardId);
          if (saved) saved.forEach(m => { existingMappings[m.monday_column_id] = m.pipeline_field; });
        } catch (e) { /* first time */ }

        if (mondayBoardColumns.length === 0) {
          container.innerHTML = '<p style="color:#888; font-size:13px;">No columns found on this board.</p>';
          return;
        }

        const sectionLabels = { pipeline: 'Pipeline', pre_approvals: 'Pre-Approvals', funded_loans: 'Funded Loans' };

        container.innerHTML =
          '<p style="font-size:12px; color:#888; margin:0 0 6px;">Board: <strong>' + escHtml(data.boardName) + '</strong> — ' + mondayBoardColumns.length + ' columns — Section: <span class="badge ' + (section === 'pipeline' ? 'section-pipeline' : section === 'pre_approvals' ? 'section-preapprovals' : 'section-funded') + '">' + escHtml(sectionLabels[section] || section) + '</span></p>' +
          '<div style="max-height:350px; overflow-y:auto; border:1px solid #eee; border-radius:8px;">' +
            '<table class="admin-table" style="margin:0; font-size:12px;">' +
              '<thead><tr><th>Monday.com Column</th><th>Type</th><th>Maps To</th></tr></thead>' +
              '<tbody>' +
                mondayBoardColumns.map(col => {
                  const savedField = existingMappings[col.id] || col.suggestedField || '';
                  return '<tr>' +
                    '<td>' + escHtml(col.title) + '</td>' +
                    '<td><code style="font-size:11px;">' + escHtml(col.type) + '</code></td>' +
                    '<td><select class="monday-mapping-select" data-col-id="' + escHtml(col.id) + '" data-col-title="' + escHtml(col.title) + '" style="padding:4px 8px; font-size:12px; border:1px solid #ddd; border-radius:6px; width:100%;">' +
                      '<option value="">— skip —</option>' +
                      validFields.map(f => '<option value="' + f + '"' + (f === savedField ? ' selected' : '') + '>' + escHtml(fieldLabels[f] || f) + '</option>').join('') +
                    '</select></td>' +
                  '</tr>';
                }).join('') +
              '</tbody>' +
            '</table>' +
          '</div>';

        saveBtn.style.display = '';
      } catch (err) {
        container.innerHTML = '<p style="color:#e74c3c; font-size:13px;">Failed to load columns: ' + escHtml(err.message) + '</p>';
      }
    }

    async function saveMondayMappings() {
      const selects = document.querySelectorAll('.monday-mapping-select');
      const mappings = [];
      selects.forEach(sel => {
        if (sel.value) {
          mappings.push({
            mondayColumnId: sel.dataset.colId,
            mondayColumnTitle: sel.dataset.colTitle,
            pipelineField: sel.value,
          });
        }
      });

      if (mappings.length === 0) return alert('Please map at least one column.');

      // Check for duplicates
      const fields = mappings.map(m => m.pipelineField);
      const dupes = fields.filter((f, i) => fields.indexOf(f) !== i);
      if (dupes.length > 0) return alert('Duplicate mapping: "' + dupes[0] + '" is mapped to multiple columns.');

      try {
        await api('/monday/mappings', {
          method: 'POST',
          body: JSON.stringify({ mappings, boardId: mondayCurrentBoardId }),
        });
        alert('Mappings saved for board ' + mondayCurrentBoardId + '! (' + mappings.length + ' columns mapped)');
        loadMondayDisplayConfig();
      } catch (err) { alert('Failed to save: ' + err.message); }
    }

    document.getElementById('mondayLoadColumnsBtn').addEventListener('click', loadMondayColumns);
    document.getElementById('mondaySaveMappingsBtn').addEventListener('click', saveMondayMappings);

    // ── Display Config ──
    async function loadMondayDisplayConfig() {
      const container = document.getElementById('mondayDisplayConfig');
      const saveBtn = document.getElementById('mondaySaveDisplayBtn');
      if (!container) return;

      try {
        const config = await api('/monday/view-config');
        if (!config) return;
        const columns = config.columns || [];

        if (columns.length <= 1) {
          container.innerHTML = '<p style="font-size:13px; color:#888;">Save column mappings first, then configure display here.</p>';
          saveBtn.style.display = 'none';
          return;
        }

        container.innerHTML =
          '<div style="max-height:350px; overflow-y:auto; border:1px solid #eee; border-radius:8px;">' +
            '<table class="admin-table" style="margin:0; font-size:12px;" id="displayConfigTable">' +
              '<thead><tr><th style="width:40px;">Show</th><th>Field</th><th>Label</th><th style="width:80px;">Order</th></tr></thead>' +
              '<tbody>' +
                columns.map((col, idx) => {
                  const isLocked = col.locked;
                  return '<tr data-field="' + col.field + '">' +
                    '<td style="text-align:center;"><input type="checkbox" class="dc-visible"' + (col.visible !== false ? ' checked' : '') + (isLocked ? ' disabled' : '') + ' /></td>' +
                    '<td><code style="font-size:11px;">' + escHtml(col.field) + '</code></td>' +
                    '<td><input type="text" class="dc-label" value="' + escHtml(col.label || '') + '"' + (isLocked ? ' disabled' : '') + ' style="padding:4px 8px; font-size:12px; border:1px solid #ddd; border-radius:6px; width:100%;" /></td>' +
                    '<td style="text-align:center;">' +
                      '<button type="button" class="btn btn-secondary btn-sm dc-move-up" style="padding:2px 6px; font-size:10px;"' + (idx === 0 ? ' disabled' : '') + '>&#9650;</button> ' +
                      '<button type="button" class="btn btn-secondary btn-sm dc-move-down" style="padding:2px 6px; font-size:10px;"' + (idx === columns.length - 1 ? ' disabled' : '') + '>&#9660;</button>' +
                    '</td>' +
                  '</tr>';
                }).join('') +
              '</tbody>' +
            '</table>' +
          '</div>';

        saveBtn.style.display = '';

        // Wire move buttons
        container.querySelectorAll('.dc-move-up').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const row = e.target.closest('tr');
            const prev = row.previousElementSibling;
            if (prev) row.parentNode.insertBefore(row, prev);
            updateMoveButtons();
          });
        });
        container.querySelectorAll('.dc-move-down').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const row = e.target.closest('tr');
            const next = row.nextElementSibling;
            if (next) row.parentNode.insertBefore(next, row);
            updateMoveButtons();
          });
        });
      } catch (err) {
        container.innerHTML = '<p style="color:#e74c3c; font-size:13px;">Failed to load display config: ' + escHtml(err.message) + '</p>';
      }
    }

    function updateMoveButtons() {
      const rows = document.querySelectorAll('#displayConfigTable tbody tr');
      rows.forEach((row, idx) => {
        const up = row.querySelector('.dc-move-up');
        const down = row.querySelector('.dc-move-down');
        if (up) up.disabled = idx === 0;
        if (down) down.disabled = idx === rows.length - 1;
      });
    }

    async function saveMondayDisplaySettings() {
      const rows = document.querySelectorAll('#displayConfigTable tbody tr');
      const displayConfig = {};
      let order = 0;
      rows.forEach(row => {
        const field = row.dataset.field;
        if (field === 'client_name') return;
        displayConfig[field] = {
          displayLabel: row.querySelector('.dc-label').value.trim() || null,
          displayOrder: order++,
          visible: row.querySelector('.dc-visible').checked,
        };
      });

      try {
        // Get all board IDs
        const data = await api('/monday/boards');
        if (!data) return;
        const boards = (data.boards || []).filter(b => b.is_active);

        for (const board of boards) {
          let boardMappings = [];
          try { boardMappings = await api('/monday/mappings?board=' + board.board_id); } catch (e) { continue; }
          if (!boardMappings || boardMappings.length === 0) continue;

          const updated = boardMappings.map(m => ({
            mondayColumnId: m.monday_column_id,
            mondayColumnTitle: m.monday_column_title,
            pipelineField: m.pipeline_field,
            displayLabel: displayConfig[m.pipeline_field] ? displayConfig[m.pipeline_field].displayLabel : (m.display_label || null),
            displayOrder: displayConfig[m.pipeline_field] ? displayConfig[m.pipeline_field].displayOrder : (m.display_order || 99),
            visible: displayConfig[m.pipeline_field] ? displayConfig[m.pipeline_field].visible : (m.visible !== 0),
          }));

          await api('/monday/mappings', {
            method: 'POST',
            body: JSON.stringify({ mappings: updated, boardId: board.board_id }),
          });
        }

        alert('Display settings saved!');
      } catch (err) { alert('Failed to save display settings: ' + err.message); }
    }

    document.getElementById('mondaySaveDisplayBtn').addEventListener('click', saveMondayDisplaySettings);

    // ── Sync Controls ──
    async function runMondaySync() {
      const btn = document.getElementById('mondayRunSyncBtn');
      const info = document.getElementById('mondaySyncInfo');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
      info.textContent = 'Sync in progress...';

      try {
        const result = await api('/monday/sync', { method: 'POST', body: '{}' });
        if (!result) { info.textContent = 'Sync failed.'; return; }
        const delMsg = result.deleted ? ', ' + result.deleted + ' removed' : '';
        info.innerHTML = '<span style="color:#2e7d32;">Sync complete! ' + result.itemsFetched + ' items (' + result.created + ' new, ' + result.updated + ' updated' + delMsg + ')</span>';
        loadMondaySyncHistory();
      } catch (err) {
        info.innerHTML = '<span style="color:#e74c3c;">Sync failed: ' + escHtml(err.message) + '</span>';
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-play"></i> Run Sync Now';
      }
    }

    async function loadMondaySyncHistory() {
      const container = document.getElementById('mondaySyncHistory');
      if (!container) return;

      try {
        const logs = await api('/monday/sync/log');
        if (!logs || logs.length === 0) {
          container.textContent = 'No syncs have been run yet.';
          return;
        }

        const statusColors = { success: '#2e7d32', error: '#e74c3c', running: '#f39c12' };

        container.innerHTML =
          '<table class="admin-table" style="margin:0; font-size:12px;">' +
            '<thead><tr><th>Date</th><th>Board</th><th>Section</th><th>Status</th><th>Items</th><th>New</th><th>Updated</th></tr></thead>' +
            '<tbody>' +
              logs.slice(0, 15).map(log =>
                '<tr>' +
                '<td style="white-space:nowrap;">' + new Date(log.started_at).toLocaleString() + '</td>' +
                '<td><code style="font-size:11px;">' + escHtml(log.board_name || log.board_id) + '</code></td>' +
                '<td>' + escHtml(log.target_section || 'pipeline') + '</td>' +
                '<td><span style="color:' + (statusColors[log.status] || '#888') + '; font-weight:600;">' + escHtml(log.status) + '</span></td>' +
                '<td>' + (log.items_synced || 0) + '</td>' +
                '<td>' + (log.items_created || 0) + '</td>' +
                '<td>' + (log.items_updated || 0) + '</td>' +
                '</tr>'
              ).join('') +
            '</tbody>' +
          '</table>';
      } catch (e) {
        container.textContent = 'Could not load sync history.';
      }
    }

    document.getElementById('mondayRunSyncBtn').addEventListener('click', runMondaySync);

    /* ── Init ── */
    document.addEventListener('DOMContentLoaded', () => {
      // Verify admin access
      api('/me').then(me => {
        if (!me || String(me.role).toLowerCase() !== 'admin') {
          document.body.innerHTML = '<div style="text-align:center; padding:80px 20px; color:#e74c3c;"><i class="fas fa-lock" style="font-size:48px; margin-bottom:12px; display:block;"></i><p style="font-size:16px;">Admin access required.</p></div>';
          return;
        }

        // Hash-based deep linking
        var hash = window.location.hash;
        if (hash === '#monday') {
          document.querySelector('[data-tab="monday"]').click();
        } else if (hash === '#investors') {
          document.querySelector('[data-tab="investors"]').click();
        } else {
          loadUsers();
        }
      });
    });
  })();
  </script>
</body>
</html>
